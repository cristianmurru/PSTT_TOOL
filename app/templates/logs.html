<!DOCTYPE html>
<html lang="it" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Viewer - {{ app_name }}</title>
    <script src="/static/css/tailwind.min.js"></script>
    <link rel="stylesheet" href="/static/css/fontawesome.min.css">
    <!-- Mark.js for keyword highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"></script>
</head>
<body class="h-full">
<div class="min-h-full">
    <nav class="bg-white shadow-lg border-b border-gray-200 relative">
        <div class="w-full px-4 lg:px-6">
            <div class="flex items-center h-16">
                <!-- Left: Brand -->
                <div class="flex items-center flex-shrink-0">
                    <span class="fa-inline text-blue-600 text-2xl mr-3" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf1c0;</span>
                    <span class="font-bold text-xl text-gray-900">{{ app_name }}</span>
                    {% if app_environment %}
                        <span class="text-xs text-gray-600" style="position: relative; top: 12px; margin-left: 8px;">{{ app_environment }}</span>
                    {% endif %}
                </div>
                <!-- Center: Links -->
                <div class="flex items-center justify-end flex-1 gap-4 mr-10">
                    <a href="/" class="text-blue-600 hover:underline text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf015;</span>Home</a>
                    <a href="/dashboard" class="text-blue-600 hover:underline text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf073;</span>Schedulazioni</a>
                    <a href="/kafka" class="text-blue-600 hover:underline text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf550;</span>Kafka</a>
                    <a href="/settings" class="text-blue-600 hover:underline text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf013;</span>Impostazioni</a>
                    <!-- Help Menu -->
                    <div class="relative">
                        <button id="helpMenuBtn" class="text-blue-600 hover:underline text-sm px-2 py-1 cursor-pointer" aria-label="Guida">
                            <span class="fa-inline" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf059;</span>
                        </button>
                        <div id="helpDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-50">
                            <a href="/docs/readme" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">README</a>
                            <a href="/docs/changelog" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CHANGELOG</a>
                            <a href="/docs/troubleshooting" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">TROUBLESHOOTING</a>
                        </div>
                    </div>
                </div>
                <!-- Right: Active Page -->
                <div class="flex items-center flex-shrink-0">
                    <span class="font-normal text-xl text-gray-900 flex items-center">
                        <i class="fas fa-eye text-blue-600 mr-2"></i>Log Viewer
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="w-full py-6 px-4 lg:px-6">
        <div class="bg-white shadow rounded-lg p-6">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="form-label">File log</label>
                    <select id="fileSelect" class="form-input"></select>
                </div>
                <div>
                    <label class="form-label">Tail (righe finali)</label>
                    <input id="tailInput" type="number" class="form-input" placeholder="es. 500" />
                </div>
            </div>

            <!-- Search Controls -->
            <div class="flex items-center gap-2 mb-3">
                <input id="searchInput" type="text" placeholder="Cerca parola chiave..." class="border border-gray-300 rounded-md px-3 py-2 w-72 text-sm" />
                <button id="searchPrev" class="btn-secondary text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf062;</span>Prev</button>
                <button id="searchNext" class="btn-secondary text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf063;</span>Next</button>
                <button id="searchClear" class="btn-secondary text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf12d;</span>Pulisci</button>
                <span id="searchCount" class="text-sm text-gray-600 ml-2">0 risultati</span>
            </div>

            <div class="border border-gray-300 rounded-md p-3 bg-gray-50">
                <pre id="logContent" class="text-xs whitespace-pre-wrap overflow-x-auto" style="min-height: 50vh; height: calc(100vh - 240px);"></pre>
            </div>
        </div>
    </div>
</div>

<style>
.form-input { min-width: 220px; max-width: 100%; height: 32px; font-size: 0.95rem; padding: 0.25rem 0.5rem; overflow: hidden; text-overflow: ellipsis; }
.btn-primary { background-color: #2563eb; color: #fff; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; display: flex; align-items: center; }
.btn-primary:hover { background-color: #1d4ed8; }
.btn-secondary { background-color: #e5e7eb; color: #1f2937; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; display: flex; align-items: center; }
.btn-secondary:hover { background-color: #d1d5db; }
</style>

<script>
async function loadFilesAndDefault() {
    try {
        const r = await fetch('/api/logs/list');
        const data = await r.json();
        const sel = document.getElementById('fileSelect');
        const items = (data.files || []).sort((a,b) => Number(b.mtime) - Number(a.mtime));
        sel.innerHTML = items.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
        const preferred = ['errors.log','app.log','scheduler.log'];
        let def = items.find(x => preferred.includes(x.name))?.name || (items[0]?.name);
        if (def) { sel.value = def; await loadSelected(); }
    } catch (e) { console.error(e); }
}
async function loadSelected() {
    const file = document.getElementById('fileSelect').value;
    const tail = document.getElementById('tailInput').value;
    if (!file) return;
    const qs = tail ? `?file=${encodeURIComponent(file)}&tail=${encodeURIComponent(tail)}` : `?file=${encodeURIComponent(file)}`;
    const r = await fetch('/api/logs/read' + qs);
    const txt = await r.text();
    const el = document.getElementById('logContent');
    el.innerHTML = escapeHtml(txt);
    // Re-apply search term if present
    const currentTerm = document.getElementById('searchInput').value;
    if (currentTerm && currentTerm.trim().length >= 2) {
        doSearch(currentTerm);
    } else {
        clearHighlights();
    }
}
loadFilesAndDefault();
document.getElementById('fileSelect')?.addEventListener('change', loadSelected);
document.getElementById('tailInput')?.addEventListener('change', loadSelected);

// Help menu toggle
(function(){
    const btn = document.getElementById('helpMenuBtn');
    const dd = document.getElementById('helpDropdown');
    if (btn && dd) {
        btn.addEventListener('click', (e) => { e.stopPropagation(); dd.classList.toggle('hidden'); });
        document.addEventListener('click', () => { if (!dd.classList.contains('hidden')) dd.classList.add('hidden'); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') dd.classList.add('hidden'); });
    }
})();

// --- Search & highlight ---
function escapeHtml(s){
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
let marker, results = [], idx = -1;
function ensureMarker(){ if (!marker) marker = new Mark(document.getElementById('logContent')); }
function updateCount(){
    const el = document.getElementById('searchCount');
    el.textContent = `${results.length} risultati${results.length && idx>=0 ? ` â€” ${idx+1}/${results.length}`: ''}`;
}
function clearHighlights(){ ensureMarker(); marker.unmark({ done: () => { results = []; idx = -1; updateCount(); } }); }
function doSearch(term){
    ensureMarker();
    clearHighlights();
    if (!term || term.trim().length < 2) return;
    marker.mark(term, {
        separateWordSearch: true,
        caseSensitive: false,
        className: 'bg-yellow-200',
        done: () => {
            results = Array.from(document.getElementById('logContent').querySelectorAll('mark'));
            idx = results.length ? 0 : -1;
            if (idx>=0) results[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateCount();
        }
    });
}
document.getElementById('searchInput')?.addEventListener('input', (e) => doSearch(e.target.value));
document.getElementById('searchClear')?.addEventListener('click', () => { document.getElementById('searchInput').value=''; clearHighlights(); });
document.getElementById('searchNext')?.addEventListener('click', () => {
    if (!results.length) return; idx = (idx+1)%results.length; results[idx].scrollIntoView({ behavior: 'smooth', block: 'center' }); updateCount();
});
document.getElementById('searchPrev')?.addEventListener('click', () => {
    if (!results.length) return; idx = (idx-1+results.length)%results.length; results[idx].scrollIntoView({ behavior: 'smooth', block: 'center' }); updateCount();
});
</script>
</body>
</html>
