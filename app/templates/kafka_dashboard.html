<!DOCTYPE html>
<html lang="it" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka Dashboard - {{ app_name }} v{{ app_version }}</title>
    
    <!-- Tailwind CSS -->
    <script src="/static/css/tailwind.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .connection-active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.4);
        }
        .connection-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.4);
        }
        .loading { opacity: 0.6; pointer-events: none; }
        .status-bar { background: linear-gradient(135deg, #1f2937 0%, #374151 100%); }
        .metric-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .metric-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <!-- Navigation Header -->
        <nav class="bg-white shadow-lg border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-database text-blue-600 text-2xl mr-3"></i>
                        <span class="font-bold text-xl text-gray-900">{{ app_name }}</span>
                        <span class="text-sm text-gray-500 ml-2">v{{ app_version }}</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-blue-600 hover:underline text-sm">
                            <i class="fas fa-home mr-1"></i>Home
                        </a>
                        <a href="/dashboard" class="text-blue-600 hover:underline text-sm">
                            <i class="fas fa-calendar-alt mr-1"></i>Schedulazioni
                        </a>
                        <a href="/logs" class="text-blue-600 hover:underline text-sm">
                            <i class="fas fa-file-alt mr-1"></i>Log
                        </a>
                        <a href="/settings" class="text-blue-600 hover:underline text-sm">
                            <i class="fas fa-gear mr-1"></i>Impostazioni
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Status Bar -->
        <div class="status-bar text-white p-3">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between text-sm">
                <div class="flex items-center space-x-4">
                    <span>Connessione Kafka: 
                        <span id="kafkaConnectionName" class="font-medium">Nessuna</span>
                    </span>
                    <span id="kafkaStatusIndicator">
                        <i class="fas fa-circle text-gray-400"></i>
                        <span id="kafkaStatusText" class="ml-1">Disconnesso</span>
                    </span>
                </div>
                <div id="metricsBar" class="flex items-center space-x-4 hidden">
                    <span>Messaggi: <span id="metricMessages" class="font-medium">0</span></span>
                    <span>Successi: <span id="metricSuccess" class="font-medium text-green-400">0</span></span>
                    <span>Errori: <span id="metricErrors" class="font-medium text-red-400">0</span></span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">

                <!-- Connection Management Section -->
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-plug mr-2"></i>Gestione Connessioni Kafka
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Connection Selector -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Seleziona Connessione
                            </label>
                            <select id="kafkaConnectionSelect" 
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                        
                        <!-- Connection Actions -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Azioni</label>
                            <div class="flex space-x-2">
                                <button id="testConnectionBtn" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                                    <i class="fas fa-check-circle mr-2"></i>Test Connessione
                                </button>
                                <button id="refreshConnectionsBtn" 
                                        class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
                                    <i class="fas fa-sync-alt mr-2"></i>Aggiorna
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Info -->
                    <div id="connectionInfo" class="mt-4 hidden">
                        <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Informazioni Connessione</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Servers:</span>
                                    <p id="infoServers" class="font-medium text-gray-900">-</p>
                                </div>
                                <div>
                                    <span class="text-gray-600">Environment:</span>
                                    <p id="infoEnvironment" class="font-medium text-gray-900">-</p>
                                </div>
                                <div>
                                    <span class="text-gray-600">Timeout:</span>
                                    <p id="infoTimeout" class="font-medium text-gray-900">-</p>
                                </div>
                                <div>
                                    <span class="text-gray-600">Stato:</span>
                                    <p id="infoStatus" class="font-medium">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metrics Section -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Messaggi Inviati</p>
                                <p id="metricTotalMessages" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <i class="fas fa-paper-plane text-blue-500 text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Success Rate</p>
                                <p id="metricSuccessRate" class="text-2xl font-bold text-green-600">0%</p>
                            </div>
                            <i class="fas fa-check-circle text-green-500 text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Latenza Media</p>
                                <p id="metricAvgLatency" class="text-2xl font-bold text-gray-900">0ms</p>
                            </div>
                            <i class="fas fa-clock text-yellow-500 text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Errori</p>
                                <p id="metricTotalErrors" class="text-2xl font-bold text-red-600">0</p>
                            </div>
                            <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Publish Message Section -->
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-edit mr-2"></i>Pubblica Messaggio (Debug/Test)
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                            <input type="text" id="publishTopic" placeholder="es: test-topic" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message Key (opzionale)</label>
                            <input type="text" id="publishKey" placeholder="es: msg-001" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Message Value (JSON)</label>
                        <textarea id="publishValue" rows="6" placeholder='{"data": "esempio", "timestamp": "2025-01-13T10:00:00"}' 
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                    </div>
                    
                    <button id="publishMessageBtn" 
                            class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition">
                        <i class="fas fa-paper-plane mr-2"></i>Invia Messaggio
                    </button>
                </div>

                <!-- Batch Publish Section -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-layer-group mr-2"></i>Pubblicazione Batch
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                            <input type="text" id="batchTopic" placeholder="es: batch-topic" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Batch Size</label>
                            <input type="number" id="batchSize" value="100" min="1" max="10000" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Max Retries</label>
                            <input type="number" id="batchRetries" value="3" min="1" max="10" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Messages (Array JSON - ogni elemento con 'key' e 'value')
                        </label>
                        <textarea id="batchMessages" rows="8" 
                                  placeholder='[{"key": "msg1", "value": {"data": "test1"}}, {"key": "msg2", "value": {"data": "test2"}}]'
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                    </div>
                    
                    <button id="publishBatchBtn" 
                            class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 transition">
                        <i class="fas fa-layer-group mr-2"></i>Invia Batch
                    </button>
                    
                    <!-- Batch Result -->
                    <div id="batchResult" class="mt-4 hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                            <h4 class="text-sm font-medium text-blue-900 mb-2">Risultato Batch</h4>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="text-blue-700">Totale:</span>
                                    <span id="batchTotal" class="font-bold ml-2">0</span>
                                </div>
                                <div>
                                    <span class="text-green-700">Successi:</span>
                                    <span id="batchSuccess" class="font-bold ml-2 text-green-600">0</span>
                                </div>
                                <div>
                                    <span class="text-red-700">Errori:</span>
                                    <span id="batchErrors" class="font-bold ml-2 text-red-600">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle mr-2"></i>${message}`;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Load Kafka connections
        async function loadConnections() {
            try {
                const response = await fetch('/api/kafka/connections');
                if (!response.ok) throw new Error('Failed to load connections');
                
                const data = await response.json();
                const select = document.getElementById('kafkaConnectionSelect');
                select.innerHTML = '<option value="">-- Seleziona connessione --</option>';
                
                data.connections.forEach(conn => {
                    const option = document.createElement('option');
                    option.value = conn.name;
                    option.textContent = `${conn.name} (${conn.environment}) - ${conn.bootstrap_servers}`;
                    select.appendChild(option);
                });
                
                if (data.default_connection) {
                    select.value = data.default_connection;
                }
            } catch (error) {
                showToast('Errore nel caricamento delle connessioni: ' + error.message, 'error');
            }
        }

        // Test connection
        async function testConnection() {
            const connectionName = document.getElementById('kafkaConnectionSelect').value;
            if (!connectionName) {
                showToast('Seleziona una connessione', 'warning');
                return;
            }
            
            const btn = document.getElementById('testConnectionBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
            
            try {
                const response = await fetch('/api/kafka/test-connection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({connection_name: connectionName})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Connessione riuscita!', 'success');
                    updateConnectionInfo(data.connection_info);
                    updateStatusBar(connectionName, true);
                } else {
                    showToast('Connessione fallita: ' + data.error, 'error');
                    updateStatusBar(connectionName, false);
                }
            } catch (error) {
                showToast('Errore nel test: ' + error.message, 'error');
                updateStatusBar(connectionName, false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Test Connessione';
            }
        }

        // Update connection info
        function updateConnectionInfo(info) {
            document.getElementById('connectionInfo').classList.remove('hidden');
            document.getElementById('infoServers').textContent = info.bootstrap_servers;
            document.getElementById('infoEnvironment').textContent = info.environment;
            document.getElementById('infoTimeout').textContent = info.connection_timeout_ms + 'ms';
            document.getElementById('infoStatus').textContent = 'âœ… Connesso';
            document.getElementById('infoStatus').className = 'font-medium text-green-600';
        }

        // Update status bar
        function updateStatusBar(name, isConnected) {
            document.getElementById('kafkaConnectionName').textContent = name;
            const indicator = document.getElementById('kafkaStatusIndicator');
            if (isConnected) {
                indicator.innerHTML = '<i class="fas fa-circle text-green-400"></i><span class="ml-1">Connesso</span>';
            } else {
                indicator.innerHTML = '<i class="fas fa-circle text-red-400"></i><span class="ml-1">Errore</span>';
            }
        }

        // Load and display metrics
        async function loadMetrics() {
            const connectionName = document.getElementById('kafkaConnectionSelect').value;
            if (!connectionName) return;
            
            try {
                const response = await fetch(`/api/kafka/metrics?connection_name=${connectionName}`);
                if (!response.ok) return;
                
                const data = await response.json();
                
                // Update metrics cards
                document.getElementById('metricTotalMessages').textContent = data.messages_sent || 0;
                document.getElementById('metricSuccessRate').textContent = 
                    (data.success_rate * 100).toFixed(1) + '%';
                document.getElementById('metricAvgLatency').textContent = 
                    (data.avg_latency_ms || 0).toFixed(1) + 'ms';
                document.getElementById('metricTotalErrors').textContent = data.errors || 0;
                
                // Update status bar metrics
                document.getElementById('metricMessages').textContent = data.messages_sent || 0;
                document.getElementById('metricSuccess').textContent = data.successful || 0;
                document.getElementById('metricErrors').textContent = data.errors || 0;
                document.getElementById('metricsBar').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        // Publish single message
        async function publishMessage() {
            const connectionName = document.getElementById('kafkaConnectionSelect').value;
            const topic = document.getElementById('publishTopic').value;
            const key = document.getElementById('publishKey').value;
            const valueText = document.getElementById('publishValue').value;
            
            if (!connectionName || !topic || !valueText) {
                showToast('Compila tutti i campi obbligatori', 'warning');
                return;
            }
            
            let value;
            try {
                value = JSON.parse(valueText);
            } catch (e) {
                showToast('Il valore deve essere JSON valido', 'error');
                return;
            }
            
            const btn = document.getElementById('publishMessageBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Invio...';
            
            try {
                const response = await fetch('/api/kafka/publish', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic,
                        key: key || null,
                        value,
                        connection_name: connectionName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Messaggio inviato con successo!', 'success');
                    loadMetrics(); // Refresh metrics
                } else {
                    showToast('Errore nell\'invio: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Invia Messaggio';
            }
        }

        // Publish batch
        async function publishBatch() {
            const connectionName = document.getElementById('kafkaConnectionSelect').value;
            const topic = document.getElementById('batchTopic').value;
            const messagesText = document.getElementById('batchMessages').value;
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const maxRetries = parseInt(document.getElementById('batchRetries').value);
            
            if (!connectionName || !topic || !messagesText) {
                showToast('Compila tutti i campi obbligatori', 'warning');
                return;
            }
            
            let messages;
            try {
                messages = JSON.parse(messagesText);
                if (!Array.isArray(messages)) {
                    throw new Error('Messages deve essere un array');
                }
            } catch (e) {
                showToast('Messages deve essere un array JSON valido', 'error');
                return;
            }
            
            const btn = document.getElementById('publishBatchBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Invio batch...';
            
            try {
                const response = await fetch('/api/kafka/publish-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic,
                        messages,
                        connection_name: connectionName,
                        batch_size: batchSize,
                        max_retries: maxRetries
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`Batch inviato: ${data.successful}/${data.total} messaggi`, 'success');
                    
                    // Show batch result
                    document.getElementById('batchResult').classList.remove('hidden');
                    document.getElementById('batchTotal').textContent = data.total;
                    document.getElementById('batchSuccess').textContent = data.successful;
                    document.getElementById('batchErrors').textContent = data.failed;
                    
                    loadMetrics(); // Refresh metrics
                } else {
                    showToast('Errore nell\'invio batch: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-layer-group mr-2"></i>Invia Batch';
            }
        }

        // Event listeners
        document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
        document.getElementById('refreshConnectionsBtn').addEventListener('click', loadConnections);
        document.getElementById('publishMessageBtn').addEventListener('click', publishMessage);
        document.getElementById('publishBatchBtn').addEventListener('click', publishBatch);
        
        // Auto-refresh metrics every 5 seconds
        setInterval(loadMetrics, 5000);
        
        // Load connections on page load
        loadConnections();
    </script>
</body>
</html>
