<!DOCTYPE html>
<html lang="it" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka Dashboard - {{ app_name }}</title>
    
    <!-- Tailwind CSS -->
    <script src="/static/css/tailwind.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .connection-active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.4);
        }
        .connection-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.4);
        }
        .loading { opacity: 0.6; pointer-events: none; }
        .status-bar { background: linear-gradient(135deg, #1f2937 0%, #374151 100%); }
        .metric-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .metric-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <!-- Navigation Header -->
        <nav class="bg-white shadow-lg border-b border-gray-200 relative">
            <div class="w-full px-4 lg:px-6">
                <div class="flex items-center h-16">
                    <!-- Left: Brand -->
                    <div class="flex items-center flex-shrink-0">
                        <span class="fa-inline text-blue-600 text-2xl mr-3" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf1c0;</span>
                        <span class="font-bold text-xl text-gray-900">{{ app_name }}</span>
                        {% if app_environment %}
                            <span class="text-xs text-gray-600" style="position: relative; top: 12px; margin-left: 8px;">{{ app_environment }}</span>
                        {% endif %}
                    </div>
                    <!-- Center: Links -->
                    <div class="flex items-center justify-end flex-1 space-x-4 mr-10">
                        {% if app_environment %}{% endif %}
                        <a href="/" class="text-blue-600 hover:underline text-sm">
                            <i class="fas fa-home mr-1"></i>Home
                        </a>
                        <a href="/dashboard" class="text-blue-600 hover:underline text-sm">
                            <i class="fas fa-calendar-alt mr-1"></i>Schedulazioni
                        </a>
                        <a href="/logs" class="text-blue-600 hover:underline text-sm">
                            <i class="fas fa-file-alt mr-1"></i>Log
                        </a>
                        <a href="/settings" class="text-blue-600 hover:underline text-sm">
                            <i class="fas fa-gear mr-1"></i>Impostazioni
                        </a>
                        <!-- Help Menu -->
                        <div class="relative">
                            <button id="helpMenuBtn" class="text-blue-600 hover:underline text-sm px-2 py-1 cursor-pointer" aria-label="Guida">
                                <i class="fas fa-question-circle"></i>
                            </button>
                            <div id="helpDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-50">
                                <a href="/docs/readme" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">README</a>
                                <a href="/docs/changelog" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CHANGELOG</a>
                                <a href="/docs/troubleshooting" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">TROUBLESHOOTING</a>
                            </div>
                        </div>
                    </div>
                    <!-- Right: Active Page -->
                    <div class="flex items-center flex-shrink-0">
                        <span class="font-normal text-xl text-gray-900 flex items-center">
                            <span class="fa-inline text-blue-600 mr-2" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf550;</span>
                            Kafka Dashboard
                        </span>
                    </div>
                </div>
            </div>
            
        </nav>

        <!-- Status Bar -->
        <div class="status-bar text-white p-3">
            <div class="w-full px-4 lg:px-6 flex items-center justify-between text-sm">

    <!-- Topic suggestions datalist -->
    <datalist id="topicSuggestions"></datalist>
                <div class="flex items-center space-x-4">
                    <span>Connessione Kafka: 
                        <span id="kafkaConnectionName" class="font-medium">Nessuna</span>
                    </span>
                    <span id="kafkaStatusIndicator">
                        <i class="fas fa-circle text-gray-400"></i>
                        <span id="kafkaStatusText" class="ml-1">Disconnesso</span>
                    </span>
                </div>
                <div id="metricsBar" class="flex items-center space-x-4 hidden">
                    <span>Messaggi: <span id="metricMessages" class="font-medium">0</span></span>
                    <span>Successi: <span id="metricSuccess" class="font-medium text-green-400">0</span></span>
                    <span>Errori: <span id="metricErrors" class="font-medium text-red-400">0</span></span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="w-full py-6 px-4 lg:px-6">
            <div class="px-4 py-6 sm:px-0">
                <!-- Page Header moved to nav -->

                <!-- Connection Management Section (moved to top under status bar) -->
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-plug mr-2"></i>Gestione Connessioni Kafka
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Connection Selector -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Seleziona Connessione
                            </label>
                            <select id="kafkaConnectionSelect" 
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Caricamento...</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-2">La selezione della connessione abilita l'elenco dei topic del cluster.</p>
                        </div>
                        
                        <!-- Connection Actions -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Azioni</label>
                            <div class="flex space-x-2">
                                <button id="testConnectionBtn" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                                    <i class="fas fa-check-circle mr-2"></i>Test Connessione (profilo selezionato)
                                </button>
                                <button id="editConnectionBtn" 
                                        class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
                                    <i class="fas fa-pen mr-2"></i>Modifica
                                </button>
                                <button id="addConnectionBtn" 
                                        class="bg-green-700 text-white px-4 py-2 rounded-md hover:bg-green-800 transition">
                                    <i class="fas fa-plus mr-2"></i>Aggiungi
                                </button>
                                <button id="refreshConnectionsBtn" 
                                        class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
                                    <i class="fas fa-sync-alt mr-2"></i>Aggiorna
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Topic selection from cluster -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topic (cluster)</label>
                            <select id="kafkaTopicSelect" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- seleziona connessione per caricare --</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-2">Il topic scelto aggiorna i contatori di messaggi/errori e filtra le tabelle.</p>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>Connessione selezionata: <span id="connectionSelectedForTopics">Nessuna</span></p>
                        </div>
                    </div>

                    <!-- Connection Info -->
                    <div id="connectionInfo" class="mt-4">
                        <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Informazioni Connessione</h3>
                            <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm items-start">
                                <div class="col-span-2 md:col-span-3 whitespace-nowrap">
                                    <span class="text-gray-600">Servers:</span>
                                    <p id="infoServers" class="font-medium text-gray-900 whitespace-nowrap">-</p>
                                </div>
                                <div class="md:col-span-1">
                                    <span class="text-gray-600">Timeout:</span>
                                    <p id="infoTimeout" class="font-medium text-gray-900">-</p>
                                </div>
                                <div class="md:col-span-1">
                                    <span class="text-gray-600">Environment:</span>
                                    <p id="infoEnvironment" class="font-medium text-gray-900">-</p>
                                </div>
                                <div class="md:col-span-1">
                                    <span class="text-gray-600">Stato:</span>
                                    <p id="infoStatus" class="font-medium">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manage Connection Form -->
                    <div id="manageForm" class="mt-6 hidden">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Crea/Aggiorna Connessione</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                                <input type="text" id="mcName" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="es: Kafka-COL">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bootstrap Servers</label>
                                <input type="text" id="mcBootstrap" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="host1:9092,host2:9092">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Security Protocol</label>
                                <select id="mcSecurity" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option>PLAINTEXT</option>
                                    <option>SSL</option>
                                    <option>SASL_PLAINTEXT</option>
                                    <option>SASL_SSL</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SASL Mechanism (opz.)</label>
                                <input type="text" id="mcSaslMech" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="PLAIN|SCRAM-SHA-256|SCRAM-SHA-512">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SASL Username (opz.)</label>
                                <input type="text" id="mcSaslUser" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SASL Password (opz.)</label>
                                <input type="password" id="mcSaslPass" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Default Topic (opz.)</label>
                                <input type="text" id="mcDefaultTopic" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="es: PSTT.TEST-COLL">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Environment (opz.)</label>
                                <select id="mcEnvironment" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="">-- nessuno --</option>
                                    <option value="collaudo">Collaudo</option>
                                    <option value="produzione">Produzione</option>
                                    <option value="sviluppo">Sviluppo</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione (opz.)</label>
                                <input type="text" id="mcDescription" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button id="mcTestBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition"><i class="fas fa-vial mr-2"></i>Ping (parametri sopra)</button>
                            <button id="mcSaveBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition"><i class="fas fa-save mr-2"></i>Salva</button>
                            <button id="mcDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition"><i class="fas fa-trash mr-2"></i>Elimina</button>
                            <button id="mcCancelBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition"><i class="fas fa-times mr-2"></i>Annulla</button>
                        </div>
                        <p class="text-gray-500 text-sm mt-2">Suggerimento: "Test Connessione" usa il profilo salvato selezionato in alto. "Ping" verifica i valori inseriti nel form senza salvarli.</p>
                    </div>
                </div>

                <!-- Metrics Section (now below connection panel) -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Messaggi Inviati</p>
                                <p id="metricTotalMessages" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <i class="fas fa-paper-plane text-blue-500 text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Success Rate</p>
                                <p id="metricSuccessRate" class="text-2xl font-bold text-green-600">0%</p>
                            </div>
                            <i class="fas fa-check-circle text-green-500 text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Latenza Media</p>
                                <p id="metricAvgLatency" class="text-2xl font-bold text-gray-900">0ms</p>
                            </div>
                            <i class="fas fa-clock text-yellow-500 text-3xl"></i>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Errori</p>
                                <p id="metricTotalErrors" class="text-2xl font-bold text-red-600">0</p>
                            </div>
                            <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Topic Breakdown + Recent Errors (moved to top) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Breakdown per Topic -->
                    <div class="bg-white shadow rounded-lg p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-list mr-2"></i>
                            <span>Breakdown per Topic (<span id="selectedPeriodLabel">Oggi</span>)</span>
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="text-left text-gray-600 border-b">
                                        <th class="py-2 pr-4">Topic</th>
                                        <th class="py-2 pr-4">Inviati</th>
                                        <th class="py-2 pr-4">Falliti</th>
                                        <th class="py-2 pr-4">Bytes</th>
                                        <th class="py-2 pr-4">Ultimo Invio</th>
                                    </tr>
                                </thead>
                                <tbody id="topicBreakdownBody">
                                    <tr><td class="py-2 text-gray-500" colspan="5">Nessun dato</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Errori Recenti -->
                    <div class="bg-white shadow rounded-lg p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-triangle-exclamation mr-2"></i>
                            <span>Errori Recenti</span>
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="text-left text-gray-600 border-b">
                                        <th class="py-2 pr-4">Timestamp</th>
                                        <th class="py-2 pr-4">Topic</th>
                                        <th class="py-2 pr-4">Errore</th>
                                        <th class="py-2 pr-4">Falliti</th>
                                    </tr>
                                </thead>
                                <tbody id="recentErrorsBody">
                                    <tr><td class="py-2 text-gray-500" colspan="4">Nessun errore</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- Metrics Section moved above -->

                <!-- Breakdown + Errors moved above -->

                <!-- Consumer Rapido (moved directly under connections) -->
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-1">
                        <i class="fas fa-download mr-2"></i>Consumer Rapido
                    </h2>
                    <p class="mb-3 text-sm">
                        <span>Connessione selezionata: <span id="consumerSelectedConn">Nessuna</span></span>
                        <span id="consumerHint" class="ml-1"> — seleziona la connessione nel pannello Gestione Connessioni Kafka</span>
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                            <input type="text" id="consumerTopic" placeholder="es: pstt-data" list="topicSuggestions"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Messaggi da leggere</label>
                            <input type="number" id="consumerMax" value="50" min="1" max="1000"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Origine offset</label>
                            <select id="consumerPeriod" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="latest">Ultimi (coda)</option>
                                <option value="earliest">Dall'inizio</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Decodifica automatica</label>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="consumerAutoDecode" checked>
                                <span class="text-xs text-gray-500">JSON con fallback (snappy/lz4/zstd → none)</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="consumeBtn" class="bg-gray-300 text-gray-600 px-6 py-2 rounded-md cursor-not-allowed" disabled>
                            <i class="fas fa-play mr-2"></i>Leggi Messaggi
                        </button>
                        <button id="topicInfoBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
                            <i class="fas fa-info-circle mr-2"></i>Info Topic
                        </button>
                    </div>
                    <div class="mt-4">
                        <pre id="consumerOutput" class="bg-gray-50 border border-gray-200 rounded-md p-3 overflow-auto text-sm"></pre>
                    </div>
                </div>

                <!-- Publish Message Section -->
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-edit mr-2"></i>Pubblica Messaggio (Debug/Test)
                    </h2>
                    <p class="mb-3 text-sm">
                        <span>Connessione selezionata: <span id="publishSelectedConn">Nessuna</span></span>
                        <span id="publishConnHint" class="ml-1 hidden"> — seleziona la connessione nel pannello Gestione Connessioni Kafka</span>
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                            <input type="text" id="publishTopic" placeholder="es: test-topic" list="topicSuggestions"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message Key (opzionale)</label>
                            <input type="text" id="publishKey" placeholder="es: msg-001" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Message Value (JSON)</label>
                        <textarea id="publishValue" rows="6" placeholder='{"data": "esempio", "timestamp": "2025-01-13T10:00:00"}' 
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                    </div>
                    
                    <button id="publishMessageBtn" 
                            class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition">
                        <i class="fas fa-paper-plane mr-2"></i>Invia Messaggio
                    </button>
                </div>

                <!-- Batch Publish Section -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-layer-group mr-2"></i>Pubblicazione Batch
                    </h2>
                    <p class="mb-3 text-sm">
                        <span>Connessione selezionata: <span id="batchSelectedConn">Nessuna</span></span>
                        <span id="batchConnHint" class="ml-1 hidden"> — seleziona la connessione nel pannello Gestione Connessioni Kafka</span>
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                            <input type="text" id="batchTopic" placeholder="es: batch-topic" list="topicSuggestions"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Batch Size</label>
                            <input type="number" id="batchSize" value="100" min="1" max="10000" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Max Retries</label>
                            <input type="number" id="batchRetries" value="3" min="1" max="10" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Messages (Array JSON - ogni elemento con 'key' e 'value')
                        </label>
                        <textarea id="batchMessages" rows="8" 
                                  placeholder='[{"key": "msg1", "value": {"data": "test1"}}, {"key": "msg2", "value": {"data": "test2"}}]'
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                    </div>
                    
                    <button id="publishBatchBtn" 
                            class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 transition">
                        <i class="fas fa-layer-group mr-2"></i>Invia Batch
                    </button>
                    
                    <!-- Batch Result -->
                        <div id="batchResult" class="mt-4 hidden">
                            <button id="batchNewBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition" title="Azzera e prepara un nuovo batch"><i class="fas fa-file mr-2"></i>Nuovo</button>
                            <h4 class="text-sm font-medium text-blue-900 mb-2">Risultato Batch</h4>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="text-blue-700">Totale:</span>
                                    <span id="batchTotal" class="font-bold ml-2">0</span>
                                </div>
                                <div>
                                    <span class="text-green-700">Successi:</span>
                                    <span id="batchSuccess" class="font-bold ml-2 text-green-600">0</span>
                                </div>
                                <div>
                                    <span class="text-red-700">Errori:</span>
                                    <span id="batchErrors" class="font-bold ml-2 text-red-600">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Consumer moved above -->

            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle mr-2"></i>${message}`;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Stato connessione attiva al cluster (abilita consumer solo se true)
        let kafkaConnected = false;

        // Default topic suggestion (fallback if profile doesn't have one)
        const FALLBACK_DEFAULT_TOPIC = 'PSTT.TEST-COLL';

        function updateTopicSuggestion(defaultTopic) {
            const topic = defaultTopic || FALLBACK_DEFAULT_TOPIC;
            const dl = document.getElementById('topicSuggestions');
            if (dl) {
                dl.innerHTML = `<option value="${topic}"></option>`;
            }
            const consumerInput = document.getElementById('consumerTopic');
            const publishInput = document.getElementById('publishTopic');
            const batchInput = document.getElementById('batchTopic');
            if (consumerInput) {
                consumerInput.placeholder = topic;
                if (!consumerInput.value) consumerInput.value = topic;
            }
            if (publishInput) {
                publishInput.placeholder = topic;
            }
            if (batchInput) {
                batchInput.placeholder = topic;
            }
        }

        // Load Kafka connections
        async function loadConnections() {
            try {
                const response = await fetch('/api/kafka/connections');
                if (!response.ok) throw new Error('Failed to load connections');
                
                const data = await response.json();
                const select = document.getElementById('kafkaConnectionSelect');
                select.innerHTML = '<option value="">-- Seleziona connessione --</option>';
                
                data.connections.forEach(conn => {
                    const option = document.createElement('option');
                    option.value = conn.name;
                    option.textContent = `${conn.name} - ${conn.bootstrap_servers}`;
                    select.appendChild(option);
                });
                
                if (data.default_connection) {
                    select.value = data.default_connection;
                    try {
                        const detail = await fetch(`/api/kafka/connections/${encodeURIComponent(select.value)}`).then(r=>r.json());
                        updateTopicSuggestion(detail.default_topic);
                        // load available topics for selected connection
                        await loadTopics(select.value);
                    } catch (e) {
                        updateTopicSuggestion();
                    }
                } else {
                    updateTopicSuggestion();
                }

                // Update consumer state based on current selection
                updateConsumerStateFromSelection();
            } catch (error) {
                showToast('Errore nel caricamento delle connessioni: ' + error.message, 'error');
            }
        }

        // Test connection
        async function testConnection() {
            const connectionName = document.getElementById('kafkaConnectionSelect').value;
            if (!connectionName) {
                showToast('Seleziona una connessione', 'warning');
                return;
            }
            
            const btn = document.getElementById('testConnectionBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
            
            try {
                const detail = await fetch(`/api/kafka/connections/${connectionName}`).then(r=>r.json());
                const response = await fetch('/api/kafka/test-connection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({connection_name: connectionName})
                });
                
                const data = await response.json();
                const ok = !!data.connected && !data.error;
                showToast(ok ? 'Connessione riuscita!' : ('Connessione fallita: ' + (data.error || '')), ok ? 'success' : 'error');
                updateStatusBar(connectionName, ok);
                const info = { bootstrap_servers: detail.bootstrap_servers || '-', environment: (detail.environment ?? '-'), connected: ok };
                if (data.latency_ms != null) info.connection_timeout_ms = data.latency_ms;
                updateConnectionInfo(info);
                kafkaConnected = ok;
                updateConsumerStateFromSelection();
            } catch (error) {
                showToast('Errore nel test: ' + error.message, 'error');
                updateStatusBar(connectionName, false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Test Connessione (profilo selezionato)';
            }
        }

        // Update connection info
        function updateConnectionInfo(info) {
            document.getElementById('connectionInfo').classList.remove('hidden');
            if (info.bootstrap_servers !== undefined) {
                document.getElementById('infoServers').textContent = info.bootstrap_servers;
            }
            if (info.environment !== undefined) {
                document.getElementById('infoEnvironment').textContent = info.environment;
            }
            if (Object.prototype.hasOwnProperty.call(info, 'connection_timeout_ms')) {
                const v = info.connection_timeout_ms;
                const text = (typeof v === 'number') ? (Math.round(v) + 'ms') : 'n/d';
                document.getElementById('infoTimeout').textContent = text;
            }
            if (Object.prototype.hasOwnProperty.call(info, 'connected')) {
                const isOk = !!info.connected;
                document.getElementById('infoStatus').textContent = isOk ? '✅ Connesso' : '❌ Errore';
                document.getElementById('infoStatus').className = isOk ? 'font-medium text-green-600' : 'font-medium text-red-600';
            } else if (Object.prototype.hasOwnProperty.call(info, 'statusText')) {
                document.getElementById('infoStatus').textContent = info.statusText || '-';
                document.getElementById('infoStatus').className = 'font-medium text-gray-700';
            }
        }

        // Update status bar
        function updateStatusBar(name, isConnected) {
            document.getElementById('kafkaConnectionName').textContent = name;
            const indicator = document.getElementById('kafkaStatusIndicator');
            if (isConnected) {
                indicator.innerHTML = '<i class="fas fa-circle text-green-400"></i><span class="ml-1">Connesso</span>';
            } else {
                indicator.innerHTML = '<i class="fas fa-circle text-red-400"></i><span class="ml-1">Errore</span>';
            }
        }

        // Update consumer panel button + label when selection changes
        function updateConsumerStateFromSelection() {
            const sel = document.getElementById('kafkaConnectionSelect');
            const name = sel ? sel.value : '';
            const btn = document.getElementById('consumeBtn');
            // update selected connection labels across panels
            ['consumerSelectedConn','publishSelectedConn','batchSelectedConn'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = name || 'Nessuna';
            });
            // show/hide connection selection hints across panels
            ['consumerHint','publishConnHint','batchConnHint'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    // hide hint once a connection is selected
                    if (name) el.classList.add('hidden'); else el.classList.remove('hidden');
                }
            });
            if (btn) {
                const disabled = (!name || !kafkaConnected);
                btn.disabled = disabled;
                btn.className = disabled
                    ? 'bg-gray-300 text-gray-600 px-6 py-2 rounded-md cursor-not-allowed'
                    : 'bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition';
            }
        }

        // Period selector for metrics
        const metricsPeriodSelectId = 'metricsPeriodSelect';
        const periodLabels = { today: 'Oggi', last_7_days: 'Ultimi 7 giorni', last_30_days: 'Ultimi 30 giorni', all: 'Tutto' };
        let lastSummaryData = null;

        function updateSelectedPeriodLabel(period) {
            const el = document.getElementById('selectedPeriodLabel');
            if (el) el.textContent = periodLabels[period] || period;
        }

        // Note: explicit topic filter inputs removed; topic selection governs filtering

        // Render breakdown per topic
        function renderTopicBreakdown(byTopic) {
            const tbody = document.getElementById('topicBreakdownBody');
            tbody.innerHTML = '';
            let entries = Object.entries(byTopic || {});
            // If a topic is selected, show only that topic
            const filter = (currentSelectedTopic || '').trim();
            if (filter) {
                entries = entries.filter(([topic]) => topic === filter);
            }
            if (!entries.length) {
                tbody.innerHTML = '<tr><td class="py-2 text-gray-500" colspan="5">Nessun dato</td></tr>';
                return;
            }
            entries
                .sort((a,b) => (b[1].messages_sent||0) - (a[1].messages_sent||0))
                .forEach(([topic, stats]) => {
                    const lastSend = stats.last_send ? stats.last_send : '-';
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `
                        <td class="py-2 pr-4 font-medium text-gray-900">${topic}</td>
                        <td class="py-2 pr-4 text-green-700">${stats.messages_sent || 0}</td>
                        <td class="py-2 pr-4 text-red-700">${stats.messages_failed || 0}</td>
                        <td class="py-2 pr-4">${stats.bytes_sent || 0}</td>
                        <td class="py-2 pr-4">${lastSend}</td>
                    `;
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', () => drillDownTopic(topic));
                    tbody.appendChild(row);
                });
        }

        // Render errori recenti
        function renderRecentErrors(errors) {
            const tbody = document.getElementById('recentErrorsBody');
            tbody.innerHTML = '';
            let list = errors || [];
            const filter = (currentSelectedTopic || '').trim();
            if (filter) {
                list = list.filter(e => (e.topic || '') === filter);
            }
            if (!list.length) {
                tbody.innerHTML = '<tr><td class="py-2 text-gray-500" colspan="4">Nessun errore</td></tr>';
                return;
            }
            list.forEach(e => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                const ts = e.timestamp || '-';
                const topic = e.topic || '-';
                const err = e.error || 'Unknown error';
                const failed = e.failed_messages || 0;
                row.innerHTML = `
                    <td class="py-2 pr-4">${ts}</td>
                    <td class="py-2 pr-4">${topic}</td>
                    <td class="py-2 pr-4 text-red-700">${err}</td>
                    <td class="py-2 pr-4">${failed}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Drill-down per topic (mostra ultime entry)
        async function drillDownTopic(topic) {
            try {
                const res = await fetch(`/api/kafka/metrics/topic/${encodeURIComponent(topic)}?limit=50`);
                const data = await res.json();
                const lines = (data.metrics || []).map(m => JSON.stringify(m, null, 2));
                showToast(`Topic '${topic}': ${data.count} righe`,'info');
                const out = document.getElementById('consumerOutput');
                out.textContent = lines.join('\n\n');
            } catch (e) {
                showToast('Errore drill-down topic: ' + e.message, 'error');
            }
        }

        // Load and display metrics (aggregated summary)
        async function loadMetrics(period = 'today') {
            // Mostra metriche aggregate
            try {
                const response = await fetch(`/api/kafka/metrics/summary?period=${encodeURIComponent(period)}`);
                if (!response.ok) return;
                const summary = await response.json();
            lastSummaryData = summary;
            updateSelectedPeriodLabel(period);
            // Sync both period selectors
            try {
                const sel1 = document.getElementById('metricsPeriodSelect');
                const sel2 = document.getElementById('metricsPeriodSelectErrors');
                if (sel1) sel1.value = period;
                if (sel2) sel2.value = period;
            } catch(e) {}

                // Update metrics cards (use aggregated values)
                const totalMessages = summary.total_messages || 0;
                const successRate = typeof summary.success_rate === 'number' ? summary.success_rate : 0;
                const avgLatency = typeof summary.avg_latency_ms === 'number' ? summary.avg_latency_ms : 0;
                const totalErrors = summary.failed_messages || 0;

                document.getElementById('metricTotalMessages').textContent = totalMessages;
                document.getElementById('metricSuccessRate').textContent = successRate.toFixed(1) + '%';
                document.getElementById('metricAvgLatency').textContent = avgLatency.toFixed(1) + 'ms';
                document.getElementById('metricTotalErrors').textContent = totalErrors;

                // Update status bar metrics
                document.getElementById('metricMessages').textContent = totalMessages;
                document.getElementById('metricSuccess').textContent = (summary.successful_messages || 0);
                document.getElementById('metricErrors').textContent = totalErrors;
                document.getElementById('metricsBar').classList.remove('hidden');

                // Render breakdown + recent errors
                renderTopicBreakdown(summary.by_topic);
                renderRecentErrors(summary.recent_errors);

                // If a topic is selected, adjust counters to reflect it
                updateTopicCounters();
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        // Consume quick messages
        async function consumeMessages() {
            const connectionName = document.getElementById('kafkaConnectionSelect').value;
            const topic = document.getElementById('consumerTopic').value;
            const maxMsgs = parseInt(document.getElementById('consumerMax').value);
            const period = (document.getElementById('consumerPeriod')?.value) || 'latest';
            const autoDecode = document.getElementById('consumerAutoDecode').checked;
            if (!connectionName || !topic) {
                showToast('Seleziona connessione e specifica topic', 'warning');
                return;
            }
            const btn = document.getElementById('consumeBtn');
            btn.disabled = true;
            btn.className = 'bg-green-600 text-white px-6 py-2 rounded-md';
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Lettura...';
            try {
                const res = await fetch('/api/kafka/consume', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ topic, connection_name: connectionName, max_messages: maxMsgs, period })
                });
                const data = await res.json();
                if (!res.ok) {
                    const detail = data?.detail || `HTTP ${res.status}`;
                    showToast('Errore lettura: ' + detail, 'error');
                    return;
                }
                const out = document.getElementById('consumerOutput');
                const lines = (data.messages || []).map(m => {
                    if (autoDecode && m.value_json) return JSON.stringify(m, null, 2);
                    // mostra value_text prettificato se disponibile
                    return JSON.stringify(m, null, 2);
                });
                out.textContent = lines.join('\n\n');
                showToast(`Letti ${data.count || 0} messaggi`, 'success');
            } catch (e) {
                showToast('Errore lettura: ' + e.message, 'error');
            } finally {
                const canConsume = (!!document.getElementById('kafkaConnectionSelect').value && kafkaConnected);
                btn.disabled = !canConsume;
                btn.className = canConsume
                    ? 'bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition'
                    : 'bg-gray-300 text-gray-600 px-6 py-2 rounded-md cursor-not-allowed';
                btn.innerHTML = '<i class="fas fa-play mr-2"></i>Leggi Messaggi';
            }
        }

        // Topic info diagnostics
        async function showTopicInfo() {
            const connectionName = document.getElementById('kafkaConnectionSelect').value;
            const topic = document.getElementById('consumerTopic').value;
            if (!connectionName || !topic) {
                showToast('Seleziona connessione e topic', 'warning');
                return;
            }
            try {
                const res = await fetch(`/api/kafka/topic-info/${encodeURIComponent(topic)}?connection_name=${encodeURIComponent(connectionName)}`);
                const data = await res.json();
                if (res.ok) {
                    const out = document.getElementById('consumerOutput');
                    out.textContent = JSON.stringify(data, null, 2);
                    const total = data.estimated_messages ?? 0;
                    showToast(`Topic '${data.topic}': partizioni ${data.partitions}, stimati ${total} messaggi`, 'info');
                } else {
                    showToast('Errore topic-info: ' + (data.detail || res.status), 'error');
                }
            } catch (e) {
                showToast('Errore topic-info: ' + e.message, 'error');
            }
        }

        // Publish single message
        async function publishMessage() {
            const connectionName = document.getElementById('kafkaConnectionSelect').value;
            const topic = document.getElementById('publishTopic').value;
            const key = document.getElementById('publishKey').value;
            const valueText = document.getElementById('publishValue').value;
            
            if (!connectionName || !topic || !valueText) {
                showToast('Compila tutti i campi obbligatori', 'warning');
                return;
            }
            
            let value;
            try {
                value = JSON.parse(valueText);
            } catch (e) {
                showToast('Il valore deve essere JSON valido', 'error');
                return;
            }
            
            const btn = document.getElementById('publishMessageBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Invio...';
            
            try {
                const response = await fetch('/api/kafka/publish', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic,
                        key: key || null,
                        value,
                        connection_name: connectionName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Messaggio inviato con successo!', 'success');
                    loadMetrics(); // Refresh metrics
                } else {
                    showToast('Errore nell\'invio: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Invia Messaggio';
            }
        }

        // Publish batch
        async function publishBatch() {
            const connectionName = document.getElementById('kafkaConnectionSelect').value;
            const topic = document.getElementById('batchTopic').value;
            const messagesText = document.getElementById('batchMessages').value;
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const maxRetries = parseInt(document.getElementById('batchRetries').value);
            
            if (!connectionName || !topic || !messagesText) {
                showToast('Compila tutti i campi obbligatori', 'warning');
                return;
            }
            
            let messages;
            try {
                messages = JSON.parse(messagesText);
                if (!Array.isArray(messages)) {
                    throw new Error('Messages deve essere un array');
                }
            } catch (e) {
                showToast('Messages deve essere un array JSON valido', 'error');
                return;
            }
            
            const btn = document.getElementById('publishBatchBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Invio batch...';
            
            try {
                const response = await fetch('/api/kafka/publish-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic,
                        messages,
                        connection_name: connectionName,
                        batch_size: batchSize,
                        max_retries: maxRetries
                    })
                });
                
                const data = await response.json();

                if (response.ok) {
                    const total = (data.total ?? 0);
                    const succeeded = (data.succeeded ?? data.successful ?? 0);
                    const failed = (data.failed ?? 0);
                    const toastType = failed === 0 ? 'success' : 'warning';
                    showToast(`Batch inviato: ${succeeded}/${total} messaggi`, toastType);

                    // Show batch result
                    document.getElementById('batchResult').classList.remove('hidden');
                    document.getElementById('batchTotal').textContent = total;
                    document.getElementById('batchSuccess').textContent = succeeded;
                    document.getElementById('batchErrors').textContent = failed;

                    loadMetrics(); // Refresh metrics
                } else {
                    const errDetail = data?.detail || (Array.isArray(data?.errors) ? data.errors[0] : undefined) || response.statusText || 'Errore sconosciuto';
                    showToast('Errore nell\'invio batch: ' + errDetail, 'error');
                }
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-layer-group mr-2"></i>Invia Batch';
            }
        }

        // Event listeners
                // Manage Connections helpers
                function mcFillFromSelected() {
                    const name = document.getElementById('kafkaConnectionSelect').value;
                    if (!name) return;
                    fetch(`/api/kafka/connections/${name}`)
                        .then(r => r.json())
                        .then(d => {
                            document.getElementById('mcName').value = d.name || name;
                            document.getElementById('mcBootstrap').value = d.bootstrap_servers || '';
                            document.getElementById('mcSecurity').value = d.security_protocol || 'PLAINTEXT';
                            document.getElementById('mcSaslMech').value = d.sasl_mechanism || '';
                            document.getElementById('mcSaslUser').value = d.sasl_username || '';
                            document.getElementById('mcSaslPass').value = d.sasl_password || '';
                            document.getElementById('mcDefaultTopic').value = d.default_topic || '';
                            document.getElementById('mcEnvironment').value = d.environment || '';
                            document.getElementById('mcDescription').value = d.description || '';
                            // mostra pannello info (non sovrascrivere timeout)
                            updateConnectionInfo({ bootstrap_servers: d.bootstrap_servers || '-', environment: d.environment || '-' });
                            // aggiorna suggerimenti topic
                            updateTopicSuggestion(d.default_topic);
                        });
                }
                function mcClear() {
                    ['mcName','mcBootstrap','mcSecurity','mcSaslMech','mcSaslUser','mcSaslPass','mcDefaultTopic','mcEnvironment','mcDescription'].forEach(id => {
                        const el = document.getElementById(id);
                        if (!el) return; if (el.tagName === 'SELECT') el.value = 'PLAINTEXT'; else el.value = '';
                    });
                }
                async function mcTest() {
                    const payload = {
                        bootstrap_servers: document.getElementById('mcBootstrap').value,
                        security_protocol: document.getElementById('mcSecurity').value,
                        sasl_mechanism: document.getElementById('mcSaslMech').value || null,
                        sasl_username: document.getElementById('mcSaslUser').value || null,
                        sasl_password: document.getElementById('mcSaslPass').value || null,
                    };
                    const res = await fetch('/api/kafka/test-connection', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    const data = await res.json();
                    const ok = !!data.connected && !data.error;
                    showToast(ok ? 'Ping OK' : ('Ping fallito: ' + (data.error || '')), ok ? 'success' : 'error');
                }
                async function mcSave() {
                    const payload = {
                        name: document.getElementById('mcName').value,
                        bootstrap_servers: document.getElementById('mcBootstrap').value,
                        security_protocol: document.getElementById('mcSecurity').value,
                        sasl_mechanism: document.getElementById('mcSaslMech').value || null,
                        sasl_username: document.getElementById('mcSaslUser').value || null,
                        sasl_password: document.getElementById('mcSaslPass').value || null,
                        default_topic: document.getElementById('mcDefaultTopic').value || null,
                        environment: document.getElementById('mcEnvironment').value || null,
                        description: document.getElementById('mcDescription').value || null,
                    };
                    const res = await fetch('/api/kafka/connections', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    const out = await res.json();
                    if (res.ok && out.success) { showToast('Connessione salvata', 'success'); loadConnections(); updateConnectionInfo({ bootstrap_servers: payload.bootstrap_servers, environment: payload.environment || '-' }); }
                    else { showToast('Errore salvataggio: ' + (out.detail || out.error || res.status), 'error'); }
                }
                async function mcDelete() {
                    const name = document.getElementById('mcName').value || document.getElementById('kafkaConnectionSelect').value;
                    if (!name) { showToast('Seleziona o compila il nome', 'warning'); return; }
                    const res = await fetch(`/api/kafka/connections/${encodeURIComponent(name)}`, { method:'DELETE' });
                    const out = await res.json().catch(() => ({}));
                    if (res.ok && out.success) { showToast('Connessione eliminata', 'success'); mcClear(); loadConnections(); }
                    else { showToast('Errore eliminazione: ' + (out.detail || res.status), 'error'); }
                }
                document.getElementById('kafkaConnectionSelect').addEventListener('change', () => { mcFillFromSelected(); testConnection(); updateConsumerStateFromSelection(); loadTopics(document.getElementById('kafkaConnectionSelect').value); });
                function mcCancel() { document.getElementById('manageForm').classList.add('hidden'); }
                document.getElementById('mcCancelBtn').addEventListener('click', mcCancel);
                document.getElementById('mcTestBtn').addEventListener('click', mcTest);
                document.getElementById('mcSaveBtn').addEventListener('click', mcSave);
                document.getElementById('mcDeleteBtn').addEventListener('click', mcDelete);
            document.getElementById('addConnectionBtn').addEventListener('click', () => { mcClear(); document.getElementById('manageForm').classList.remove('hidden'); });
            document.getElementById('editConnectionBtn').addEventListener('click', () => { const name = document.getElementById('kafkaConnectionSelect').value; if (!name) { showToast('Seleziona una connessione da modificare', 'warning'); return; } mcFillFromSelected(); document.getElementById('manageForm').classList.remove('hidden'); });
        document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
        document.getElementById('refreshConnectionsBtn').addEventListener('click', loadConnections);
        document.getElementById('publishMessageBtn').addEventListener('click', publishMessage);
        document.getElementById('publishBatchBtn').addEventListener('click', publishBatch);
        document.getElementById('consumeBtn').addEventListener('click', consumeMessages);
        document.getElementById('topicInfoBtn').addEventListener('click', showTopicInfo);
        // Reset batch panel
        function resetBatchPanel(){
            try{
                const topicEl = document.getElementById('batchTopic');
                const messagesEl = document.getElementById('batchMessages');
                const sizeEl = document.getElementById('batchSize');
                const retriesEl = document.getElementById('batchRetries');
                if (messagesEl) messagesEl.value = '';
                if (topicEl && topicEl.placeholder) topicEl.value = topicEl.placeholder; else if (topicEl) topicEl.value = '';
                if (sizeEl) sizeEl.value = (sizeEl.getAttribute('value') || '100');
                if (retriesEl) retriesEl.value = (retriesEl.getAttribute('value') || '3');
                document.getElementById('batchTotal').textContent = '0';
                document.getElementById('batchSuccess').textContent = '0';
                document.getElementById('batchErrors').textContent = '0';
                document.getElementById('batchResult').classList.add('hidden');
                showToast('Pannello batch azzerato', 'info');
            } catch(e) {}
        }
        document.getElementById('batchNewBtn').addEventListener('click', resetBatchPanel);

        // Load topics for selected connection and update counters
        let currentSelectedTopic = '';
        async function loadTopics(name){
            try{
                const sel = document.getElementById('kafkaTopicSelect');
                document.getElementById('connectionSelectedForTopics').textContent = name || 'Nessuna';
                if (!name){ sel.innerHTML = '<option value="">-- seleziona connessione --</option>'; currentSelectedTopic=''; updateTopicCounters(); return; }
                const res = await fetch(`/api/kafka/topics?connection_name=${encodeURIComponent(name)}`);
                if (!res.ok){ sel.innerHTML = '<option value="">Errore caricamento topic</option>'; return; }
                const data = await res.json();
                const detail = await fetch(`/api/kafka/connections/${encodeURIComponent(name)}`).then(r=>r.json()).catch(()=>({}));
                const defTopic = detail.default_topic || '';
                const topicsList = (data.topics || []);
                const opts = topicsList.map(t => `<option value="${t}">${t}</option>`).join('');
                sel.innerHTML = `<option value="">-- seleziona topic --</option>${opts}`;
                // preselect default topic if present
                if (defTopic && topicsList.includes(defTopic)){ sel.value = defTopic; currentSelectedTopic = defTopic; }
                else { currentSelectedTopic = ''; }
                updateTopicSuggestion(currentSelectedTopic || defTopic);
                // if a topic is preselected, default period to last 7 days and refresh metrics
                if (currentSelectedTopic){
                    try{
                        const sel1 = document.getElementById('metricsPeriodSelect');
                        const sel2 = document.getElementById('metricsPeriodSelectErrors');
                        [sel1, sel2].forEach(s => { if (s) s.value = 'last_7_days'; });
                        await loadMetrics('last_7_days');
                    }catch(e){ await loadMetrics(); }
                }
                // refresh tables and counters
                try{ if (lastSummaryData){ renderTopicBreakdown(lastSummaryData.by_topic); renderRecentErrors(lastSummaryData.recent_errors); } }catch(e){}
                updateTopicCounters();
            }catch(e){ try{ document.getElementById('kafkaTopicSelect').innerHTML = '<option value="">Errore caricamento topic</option>'; }catch{} }
        }

        // Re-render sections when topic selection changes
        function rerenderSections(){
            try{
                if (lastSummaryData){
                    renderTopicBreakdown(lastSummaryData.by_topic);
                    renderRecentErrors(lastSummaryData.recent_errors);
                }
            }catch(e){}
        }

        function updateTopicCounters(){
            try{
                const topic = currentSelectedTopic || '';
                if (!lastSummaryData){ return; }
                if (topic && lastSummaryData.by_topic && lastSummaryData.by_topic[topic]){
                    const stats = lastSummaryData.by_topic[topic];
                    const sent = stats.messages_sent || 0;
                    const failed = stats.messages_failed || 0;
                    const total = sent; // per topic, contiamo i messaggi inviati
                    const rate = (sent + failed) > 0 ? (sent/(sent+failed)*100) : 0;
                    document.getElementById('metricTotalMessages').textContent = total;
                    document.getElementById('metricSuccessRate').textContent = rate.toFixed(1) + '%';
                    document.getElementById('metricTotalErrors').textContent = failed;
                    // status bar counters
                    document.getElementById('metricMessages').textContent = total;
                    document.getElementById('metricSuccess').textContent = sent;
                    document.getElementById('metricErrors').textContent = failed;
                    document.getElementById('metricsBar').classList.remove('hidden');
                } else {
                    // No data for selected topic: show zeros to reflect selection
                    document.getElementById('metricTotalMessages').textContent = 0;
                    document.getElementById('metricSuccessRate').textContent = '0.0%';
                    document.getElementById('metricTotalErrors').textContent = 0;
                    document.getElementById('metricMessages').textContent = 0;
                    document.getElementById('metricSuccess').textContent = 0;
                    document.getElementById('metricErrors').textContent = 0;
                }
            }catch(e){}
        }

        // Topic select change -> update filters and counters
        document.getElementById('kafkaTopicSelect').addEventListener('change', async (ev)=>{
            currentSelectedTopic = ev.target.value || '';
            // Default period to last 7 days when a topic is selected
            try{
                const sel1 = document.getElementById('metricsPeriodSelect');
                const sel2 = document.getElementById('metricsPeriodSelectErrors');
                [sel1, sel2].forEach(s => { if (s) s.value = 'last_7_days'; });
                await loadMetrics('last_7_days');
            }catch(e){ await loadMetrics(); }
            rerenderSections();
            updateTopicCounters();
        });

        // Removed topic search handlers per request
        
        // Period filter UI (simple select added dynamically near breakdown header)
        (function addPeriodSelector(){
            try {
                const headers = Array.from(document.querySelectorAll('h2.text-lg.font-semibold.text-gray-900.mb-3'));
                headers.forEach(h => {
                    const sel = document.createElement('select');
                    const isErrors = (h.textContent || '').includes('Errori Recenti');
                    sel.id = isErrors ? 'metricsPeriodSelectErrors' : metricsPeriodSelectId;
                    sel.className = 'ml-3 border border-gray-300 rounded px-2 py-1 text-sm';
                    sel.innerHTML = '<option value="today">Oggi</option><option value="last_7_days">Ultimi 7 giorni</option><option value="last_30_days">Ultimi 30 giorni</option>';
                    h.appendChild(sel);
                    sel.addEventListener('change', ()=> loadMetrics(sel.value));
                });
            } catch(e) {}
        })();

        // Topic filter change handler
        (function attachTopicFilter(){
            try {
                const input1 = document.getElementById('topicFilterInput');
                const input2 = document.getElementById('topicFilterInputErrors');
                function onChange(src, other){
                    currentTopicFilter = (src.value || '');
                    if (other && other.value !== currentTopicFilter) other.value = currentTopicFilter;
                    if (lastSummaryData) {
                        renderTopicBreakdown(lastSummaryData.by_topic);
                        renderRecentErrors(lastSummaryData.recent_errors);
                    }
                }
                if (input1) input1.addEventListener('input', () => onChange(input1, input2));
                if (input2) input2.addEventListener('input', () => onChange(input2, input1));
            } catch(e) {}
        })();

        // Auto-refresh metrics every 5 seconds
        setInterval(()=>{ const sel = document.getElementById(metricsPeriodSelectId); loadMetrics(sel ? sel.value : 'today'); }, 5000);
        
        // Load connections on page load
                loadConnections();
                // Mostra pannello info subito con placeholder
                updateConnectionInfo({ bootstrap_servers: '-', environment: '-', connection_timeout_ms: null, statusText: '-' });
                // Aggiorna stato consumer con nessuna selezione
                updateConsumerStateFromSelection();
                // Carica metriche iniziali
                loadMetrics('today');
    </script>
    <script>
    // Help menu toggle for Kafka navbar
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('helpMenuBtn');
        const dd = document.getElementById('helpDropdown');
        if (btn && dd) {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                dd.classList.toggle('hidden');
            });
            document.addEventListener('click', () => {
                if (!dd.classList.contains('hidden')) dd.classList.add('hidden');
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') dd.classList.add('hidden');
            });
        }
    });
    </script>
</body>
</html>
