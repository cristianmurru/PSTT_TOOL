<!DOCTYPE html>
<html lang="it" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Viewer</title>
    <script src="/static/css/tailwind.min.js"></script>
    <link rel="stylesheet" href="/static/css/fontawesome.min.css">
</head>
<body class="h-full">
<div class="min-h-full">
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-file-alt text-blue-600 text-2xl mr-3"></i>
                    <span class="font-bold text-xl text-gray-900">Log Viewer</span>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/" class="text-blue-600 hover:underline text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf015;</span>Home</a>
                    <a href="/dashboard" class="text-blue-600 hover:underline text-sm"><i class="fas fa-calendar-alt mr-1"></i>Schedulazioni</a>
                    <a href="/kafka" class="text-blue-600 hover:underline text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf550;</span>Kafka</a>
                    <a href="/settings" class="text-blue-600 hover:underline text-sm"><span class="fa-inline mr-1" style="font-family: 'Font Awesome 6 Free'; font-weight:900; display:inline-block; line-height:1;">&#xf013;</span>Impostazioni</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4"><i class="fas fa-eye mr-2"></i>Visualizzazione Log</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="form-label">File log</label>
                    <select id="fileSelect" class="form-input"></select>
                </div>
                <div>
                    <label class="form-label">Tail (righe finali)</label>
                    <input id="tailInput" type="number" class="form-input" placeholder="es. 500" />
                </div>
            </div>

            <div class="border border-gray-300 rounded-md p-3 bg-gray-50">
                <pre id="logContent" class="text-xs whitespace-pre-wrap overflow-x-auto" style="max-height: 60vh;"></pre>
            </div>
        </div>
    </div>
</div>

<style>
.form-input { min-width: 220px; max-width: 100%; height: 32px; font-size: 0.95rem; padding: 0.25rem 0.5rem; overflow: hidden; text-overflow: ellipsis; }
.btn-primary { background-color: #2563eb; color: #fff; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; display: flex; align-items: center; }
.btn-primary:hover { background-color: #1d4ed8; }
.btn-secondary { background-color: #e5e7eb; color: #1f2937; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; display: flex; align-items: center; }
.btn-secondary:hover { background-color: #d1d5db; }
</style>

<script>
async function loadFilesAndDefault() {
    try {
        const r = await fetch('/api/logs/list');
        const data = await r.json();
        const sel = document.getElementById('fileSelect');
        const items = (data.files || []).sort((a,b) => Number(b.mtime) - Number(a.mtime));
        sel.innerHTML = items.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
        // default: errors.log -> app.log -> scheduler.log -> primo disponibile
        const preferred = ['errors.log','app.log','scheduler.log'];
        let def = items.find(x => preferred.includes(x.name))?.name || (items[0]?.name);
        if (def) {
            sel.value = def;
            await loadSelected();
        }
    } catch (e) { console.error(e); }
}
async function loadSelected() {
    const file = document.getElementById('fileSelect').value;
    const tail = document.getElementById('tailInput').value;
    if (!file) return;
    const qs = tail ? `?file=${encodeURIComponent(file)}&tail=${encodeURIComponent(tail)}` : `?file=${encodeURIComponent(file)}`;
    const r = await fetch('/api/logs/read' + qs);
    const txt = await r.text();
    document.getElementById('logContent').textContent = txt;
}

// Wire UI (senza bottoni: caricamento automatico su selezione/cambio)
loadFilesAndDefault();
document.getElementById('fileSelect')?.addEventListener('change', loadSelected);
document.getElementById('tailInput')?.addEventListener('change', loadSelected);
</script>
</body>
</html>
