# Update R20260203

- Aggiornamento relativo al commit "R20260203: Fix stabilità barra di stato durante filtri (v1.1.5)".
- **Problema risolto**: La barra di stato tra selezione query e risultati si spostava visivamente ogni volta che venivano applicati filtri su lista query o tabella risultati, causando un'esperienza utente instabile.
- **Soluzione**: Altezze fisse per i container dinamici (lista query 60vh, tabella risultati 70vh) per eliminare completamente il reflow verticale; disabilitato `overflow-anchor` per prevenire salti del viewport.

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata (utente non operativo durante l'intervento).
- Percorso di installazione corrente della app (es.: `C:\PSTT_TOOL` o equivalente).
- Nome del Servizio Windows dell'applicazione (es.: `PSTT_TOOL`): verrà usato nei comandi sotto.
- Pacchetto sorgente aggiornato (cartella `app/`, `docs/`, `static/`, `templates/`, `CHANGELOG.md`, ecc.).

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (se presente nella root):
```powershell
# Eseguire nella cartella di installazione
./manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
# Verifica stato
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
Creare una copia di sicurezza dell'installazione:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-02-03"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`
  - `exports/kafka_metrics.json` (metriche Kafka accumulate)
  - `exports/scheduler_history.json` (storico schedulazioni)

Suggerimento: se usi `robocopy`, escludi esplicitamente:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv exports /XF connections.json .env
```

### Elenco aree con modifiche in R20260203
- Frontend Templates: `app/templates/index.html` — altezze fisse per container lista query (60vh) e tabella risultati (70vh); disabilitato `overflow-anchor` per `#resultsSection` e `#selectionSection`.
- Static JS: `app/static/js/main.js` — rimossa logica di compensazione scroll (`_lockScroll`, `_unlockScroll`) non più necessaria.
- Documentazione: `docs/CHANGELOG.md` — aggiunta sezione [1.1.5] con dettagli fix.
- README: `docs/README.md` — aggiornato badge versione a 1.1.5.

#### Dettaglio file da sovrascrivere
1. **`app/templates/index.html`**
   - Container lista query: aggiunto `height: 60vh; min-height: 60vh; max-height: 60vh;` per altezza fissa.
   - Container tabella risultati: aggiunto `height: 70vh; min-height: 70vh;` per altezza fissa.
   - CSS: rimosso `.table-container { max-height: 70vh; overflow: auto; }` (ora inline).
   - CSS: aggiunto `#resultsSection { overflow-anchor: none; }` e `#selectionSection { overflow-anchor: none; }`.

2. **`app/static/js/main.js`**
   - Rimossi metodi `_captureStatusBarTop()` e `_restoreStatusBarTop()`.
   - Rimossi metodi `_lockScroll()` e `_unlockScroll()`.
   - Rimossi tutti i riferimenti a logica di compensazione scroll in `renderQueryList()`, `renderFilters()`, `filterTable()`, `sortTable()`.

3. **`docs/CHANGELOG.md`**
   - Aggiunta sezione [1.1.5] in cima alla lista con data 2026-02-03 e descrizione fix.

4. **`docs/README.md`**
   - Badge versione aggiornato da 1.1.4 a 1.1.5.

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Nessuna modifica obbligatoria richiesta per R20260203.

### 4.1 `connections.json`
- Nessuna modifica strutturale richiesta.
- Garantire che la struttura sia **JSON valido** (nessuna virgola finale, chiavi/valori coerenti).
- Esempio di controllo rapido (PowerShell):
```powershell
# Valida il JSON
$path = "C:\PSTT_TOOL\connections.json"
Get-Content $path -Raw | ConvertFrom-Json | Out-Null; Write-Host "connections.json valido"
```

### 4.2 `.env`
- Nessuna modifica obbligatoria.
- Verificare le credenziali e gli endpoint esistenti (`DB_*`, `ORACLE_*`, `POSTGRES_*`, `SQLSERVER_*`, SMTP, ecc.).
- Non sono stati introdotti nuovi parametri in R20260203.

## 5) Aggiornamento dipendenze (se necessario)
- Confrontare `requirements.txt` tra versione corrente e precedente.
- **Nessuna modifica alle dipendenze** in R20260203; se `requirements.txt` è invariato, saltare questo step.
- Se necessario, aggiornare l'ambiente Python:
```powershell
# Esempio: ambiente virtuale
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

> Nota: se il server non ha accesso internet, preparare in anticipo i pacchetti wheel offline e installarli localmente.

## 6) Avvio del Servizio
- Script di gestione:
```powershell
./manage_service.ps1 start
```

- PowerShell nativo:
```powershell
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc start PSTT_TOOL
sc query PSTT_TOOL
```

## 7) Verifiche post-deploy
- **UI Home**:
  - Applicare filtri sulla lista query usando il selettore sottodirectory: la barra di stato deve rimanere ferma, senza scorrimento del viewport.
  - Eseguire una query e applicare filtri sulla tabella risultati (nei campi input sotto il titolo "Risultati Query"): la barra di stato deve rimanere ferma.
  - Verificare che lo scroll automatico avvenga **solo** dopo "Esegui Query" o "Torna a selezione", mai durante l'applicazione dei filtri.
  - I container lista query e tabella risultati devono mantenere altezze fisse (60vh e 70vh) anche quando i filtri riducono gli elementi visibili.
- **Funzionalità generali**:
  - Verificare che tutte le pagine (Home, Schedulazioni, Kafka, Log, Impostazioni) si carichino correttamente.
  - Controllare i log dell'applicazione/servizio per eventuali errori.

## 8) Rollback
In caso di problemi:
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2026-02-03" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- **Impatto minimo**: questa release corregge solo il comportamento UI della barra di stato, senza modifiche a logica backend o configurazioni.
- Evitare la sovrascrittura di `connections.json`, `.env` e file `exports/`: mantenerli allineati secondo le esigenze dell'ambiente.
- Documentare eventuali personalizzazioni locali (connessioni, permessi, cartelle di export) prima dell'aggiornamento.
- Archiviare il pacchetto sorgente e il backup per riferimento futuro.

## Checklist
- [ ] Servizio fermato
- [ ] Backup creato
- [ ] File aggiornati copiati (esclusi `connections.json`, `.env`, `exports/`)
- [ ] `connections.json` e `.env` verificati (nessuna modifica necessaria)
- [ ] Dipendenze aggiornate (se `requirements.txt` è cambiato)
- [ ] Servizio riavviato
- [ ] Verifiche UI completate (filtri, barra di stato stabile)
- [ ] Log controllati per errori
