# Update R20260128

Aggiornamento relativo ai commit su branch `feature/R20260127` (data 2026-01-28):
- Badge ENV sobrio in navbar (SVILUPPO/COLLAUDO/PRODUZIONE), posizionato in alto a destra e allineato ai link.
- Report mail schedulazioni: finestra temporale di default impostata alle ultime 24 ore rispetto all'esecuzione (non più dalla mezzanotte del giorno corrente).
- Log Viewer: rimosso codice JavaScript mostrato in chiaro; script correttamente incapsulati.

## Prerequisiti
- Accesso al server con privilegi adeguati.
- Finestra di manutenzione concordata.
- Percorso di installazione corrente dell'app (es.: `C:\PSTT_TOOL`).
- Nome del Servizio Windows (es.: `PSTT_TOOL`).
- Pacchetto sorgente aggiornato (cartelle `app/`, `docs/`, `templates/`, `frontend/`, ecc.).

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (se presente):
```powershell
# Eseguire nella cartella di installazione
./manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
Creare una copia di sicurezza:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-01-28"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
Copiare i file aggiornati nella cartella di installazione evitando di sovrascrivere:
- `connections.json`
- `.env`

Esempio con `robocopy`:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Aree modificate in R20260128
- Backend/Servizi:
  - `app/services/daily_report_service.py` — selezione esecuzioni ultime 24h quando la data non è specificata.
  - `app/services/scheduler_service.py` — job giornaliero invoca la generazione senza data per usare la finestra 24h.
- Frontend/Templates:
  - `app/templates/index.html`, `app/templates/kafka_dashboard.html`, `app/templates/markdown_viewer.html` — badge ENV in navbar.
  - `app/frontend/scheduler_dashboard.html`, `app/frontend/logs.html`, `app/frontend/settings.html` — posizionamento badge ENV, pulizia script.
- Documentazione:
  - `docs/CHANGELOG.md`, `docs/README.md` — aggiornati per nuova finestra report e badge ENV.

#### Dettaglio file da sovrascrivere
- `app/services/daily_report_service.py`
- `app/services/scheduler_service.py`
- `app/templates/index.html`
- `app/templates/kafka_dashboard.html`
- `app/templates/markdown_viewer.html`
- `app/frontend/scheduler_dashboard.html`
- `app/frontend/logs.html`
- `app/frontend/settings.html`
- `docs/CHANGELOG.md`
- `docs/README.md`

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Applicare le seguenti verifiche/modifiche manuali se necessario:

### 4.1 `.env`
- Verificare SMTP: `smtp_host`, `smtp_port`, `smtp_user`, `smtp_password`, `smtp_from` (necessari per l'invio email del report).
- Opzionale: impostare l'etichetta ambiente per il badge in navbar tramite chiave `app_environment` (valori consigliati: `SVILUPPO`, `COLLAUDO`, `PRODUZIONE`).
- Chiavi Daily Report già supportate: `DAILY_REPORT_ENABLED`, `DAILY_REPORT_CRON` (se vuoto usa `DAILY_REPORTS_HOUR`), `DAILY_REPORTS_HOUR`, `DAILY_REPORT_RECIPIENTS`, `DAILY_REPORT_CC`, `DAILY_REPORT_SUBJECT`, `DAILY_REPORT_TAIL_LINES`.

### 4.2 `connections.json`
- Confermare che la struttura JSON sia valida e allineata ai requisiti correnti.

## 5) Aggiornamento dipendenze (se necessario)
Se `requirements.txt` è cambiato, aggiornare l'ambiente:
```powershell
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

## 6) Avvio del Servizio
```powershell
./manage_service.ps1 start
# oppure
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
```

## 7) Verifiche post-deploy
- Navbar: badge ENV visibile in alto a destra, stile sobrio, allineamento verticale ai link.
- Report giornaliero: l'email include le esecuzioni delle ultime 24 ore se generata senza specifica di `date`.
- Logs: nessun JS mostrato in chiaro; menu aiuto funziona.
- Suite test (opzionale):
```powershell
C:\PSTT_TOOL\.venv\Scripts\python.exe -m pytest -q
```

## 8) Rollback
In caso di problemi:
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2026-01-28" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- Non sovrascrivere `connections.json` e `.env`.
- Documentare eventuali personalizzazioni locali.
- Conservare backup e pacchetto sorgente per audit futuro.
