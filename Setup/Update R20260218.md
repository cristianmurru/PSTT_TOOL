# Update R20260218

- **Versione**: 1.2.2
- **Data**: 2026-02-18
- **Branch**: feature/R20260212
- **Tipo intervento**: Fix parsing query + nuove query PCL

## üìã Sommario Modifiche

### Fix
1. **Query parsing multi-statement con commenti**
   - Risolto problema rilevamento tipo statement (SELECT/WITH vs DML) quando query hanno commenti inline
   - Query con header commentati ora vengono eseguite correttamente

### Nuove Query
2. **Query report PCL**
   - Aggiunte query per monitoraggio mazzetti DSX giornalieri
   - Nuove schedulazioni produzione per report operativi

### Documentazione
3. **Analisi tecnica saturazione porte DB**
   - Documento analisi incident Oracle
   - Verifica configurazione PSTT Tool (NON causa di saturazione)

## Prerequisiti
- Accesso al server con privilegi amministrativi
- Finestra di manutenzione concordata (downtime: ~2 minuti)
- Percorso installazione: `C:\PSTT_TOOL` (o equivalente)
- Nome servizio Windows: `PSTT_Tool`
- Pacchetto sorgente aggiornato dalla cartella di release

## üö® Impatto e Urgenza

**Severit√†**: MEDIA  
**Ambiente**: COLLAUDO e PRODUZIONE  
**Downtime**: ~2 minuti  

**Motivazione**: Fix per corretta esecuzione query con commenti inline. Aggiunta nuove query report per monitoraggio operativo.

## üì¶ File Modificati

### Backend Core
- `app/services/query_service.py` ‚Üí Fix parsing statement con commenti (linee 559-562, 710-713)

### Query SQL
- `Query/Report/CDG-PCL-001--Mazzetti DSX giornalieri - sintetico.sql` ‚Üí **[NUOVO]** Report sintetico
- `Query/Report/CDG-PCL-002--Monitoraggio Mazzetti giornalieri - sintetico.sql` ‚Üí **[NUOVO]** Monitoraggio operativo

### Configurazione
- `connections.json` ‚Üí Aggiornamento schedulazioni produzione

### Test
- `tests/test_system_restart.py` ‚Üí Fix test configurazione NSSM (linee 377-394)

### Documentazione
- `docs/CHANGELOG.md` ‚Üí Aggiunta versione 1.2.2
- `docs/README.md` ‚Üí Aggiornato badge versione
- `docs/ANALISI_SATURAZIONE_PORTE_DB_20260212.md` ‚Üí **[NUOVO]** Analisi tecnica incident
- `docs/TROUBLESHOOTING.md` ‚Üí Gi√† aggiornato in v1.2.1 (sezione timeout Oracle)

## üìù Procedura Aggiornamento

### 1) Stop del Servizio

```powershell
# Opzione 1: Script gestione
cd C:\PSTT_TOOL
.\manage_service.ps1 stop

# Opzione 2: PowerShell nativo
Stop-Service -Name PSTT_Tool -Force

# Verifica stato
Get-Service -Name PSTT_Tool
# Status deve essere: Stopped
```

### 2) Backup Installazione Corrente

```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2 /XD .venv __pycache__

Write-Host "Backup completato in: $dst" -ForegroundColor Green
```

### 3) Sovrascrittura File Aggiornati

**‚ö†Ô∏è IMPORTANTE: NON sovrascrivere**:
- `connections.json` (richiede modifica manuale - vedi punto 5)
- `.env` (nessuna modifica richiesta)

```powershell
# Copia file aggiornati
$source = "C:\Pacchetto\PSTT_TOOL"  # Percorso pacchetto sorgente
$dest = "C:\PSTT_TOOL"

# Copia sottocartelle app con sovrascrizione
robocopy "$source\app" "$dest\app" /E /R:2 /W:2

# Copia query (include nuove query PCL)
robocopy "$source\Query" "$dest\Query" /E /R:2 /W:2

# Copia documentazione
robocopy "$source\docs" "$dest\docs" /E /R:2 /W:2

# Copia tests
robocopy "$source\tests" "$dest\tests" /E /R:2 /W:2

# File root (esclusi .env e connections.json)
Copy-Item "$source\main.py" "$dest\main.py" -Force
Copy-Item "$source\requirements.txt" "$dest\requirements.txt" -Force
Copy-Item "$source\pytest.ini" "$dest\pytest.ini" -Force
```

### 4) Configurazione .env

**Nessuna modifica richiesta** al file `.env`.  
Il fix √® applicato a livello di codice (nessuna nuova variabile d'ambiente).

### 5) Configurazione connections.json

**‚ö†Ô∏è Modifica manuale richiesta** per aggiornare schedulazioni.

Aprire `connections.json` e verificare/aggiornare la sezione `"scheduling"`:

#### Opzione A: Aggiunta schedulazione report DSX (PRODUZIONE)

Se si vuole attivare il report DSX giornaliero su produzione, aggiungere alla sezione `"scheduling"`:

```json
{
  "query": "CDG-DSX-001--Mazzetti DSX giornalieri - sintetico.sql",
  "connection": "C00-CDG-Produzione",
  "enabled": true,
  "description": "Report giornaliero mazzetti DSX",
  "scheduling_mode": "classic",
  "end_date": null,
  "output_filename_template": "{query_name}_{datetime}.xlsx",
  "output_date_format": "%Y-%m-%d_%H%M%S",
  "output_offset_days": 0,
  "output_compress_gz": false,
  "sharing_mode": "filesystem",
  "output_dir": "C:\\PSTT_TOOL\\exports",
  "days_of_week": [1, 2, 3, 4, 5, 6, 7],
  "hour": 8,
  "minute": 30,
  "second": 0,
  "email_recipients": null,
  "kafka_topic": null
}
```

#### Opzione B: Nessuna modifica (COLLAUDO)

Se in ambiente di collaudo, **non sono necessarie modifiche** al `connections.json`.  
Le nuove query PCL sono disponibili ma non schedulate automaticamente.

#### Validazione JSON

Dopo ogni modifica, validare il file:

```powershell
$path = "C:\PSTT_TOOL\connections.json"
try {
    Get-Content $path -Raw | ConvertFrom-Json | Out-Null
    Write-Host "connections.json valido ‚úì" -ForegroundColor Green
} catch {
    Write-Error "connections.json NON valido: $_"
}
```

### 6) Verifica File Aggiornati

```powershell
# Verifica presenza nuove query
Test-Path "C:\PSTT_TOOL\Query\Report\CDG-PCL-001--Mazzetti DSX giornalieri - sintetico.sql"
Test-Path "C:\PSTT_TOOL\Query\Report\CDG-PCL-002--Monitoraggio Mazzetti giornalieri - sintetico.sql"

# Verifica documentazione
Test-Path "C:\PSTT_TOOL\docs\ANALISI_SATURAZIONE_PORTE_DB_20260212.md"

# Verifica versione nel CHANGELOG
Select-String -Path "C:\PSTT_TOOL\docs\CHANGELOG.md" -Pattern "\[1\.2\.2\]" -Quiet
```

### 7) Aggiornamento Dipendenze (opzionale)

```powershell
cd C:\PSTT_TOOL
.\.venv\Scripts\Activate.ps1

# Verifica se requirements.txt √® cambiato (diff con backup)
# Se non √® cambiato, questo step pu√≤ essere saltato
pip install -r requirements.txt --upgrade

deactivate
```

### 8) Avvio Servizio

```powershell
# Opzione 1: Script gestione
.\manage_service.ps1 start

# Opzione 2: PowerShell nativo
Start-Service -Name PSTT_Tool

# Verifica stato
Get-Service -Name PSTT_Tool
# Status deve essere: Running

# Attendi 10 secondi per avvio completo
Start-Sleep -Seconds 10
```

### 9) Verifica Funzionamento

#### a) Health Check

```powershell
$health = Invoke-RestMethod -Uri "http://localhost:8000/api/monitoring/health" -Method GET
Write-Host "Status: $($health.status)"
Write-Host "Version: $($health.version)"  # Deve essere 1.2.2
Write-Host "Uptime: $($health.uptime_seconds)s"
```

#### b) Verifica Nuove Query Disponibili

```powershell
$queries = Invoke-RestMethod -Uri "http://localhost:8000/api/queries/list" -Method GET
$pclQueries = $queries | Where-Object { $_.filename -like "CDG-PCL-*" }
Write-Host "Query PCL trovate: $($pclQueries.Count)"
foreach ($q in $pclQueries) {
    Write-Host "  - $($q.filename)"
}
```

#### c) Test Esecuzione Query con Commenti

Accedere a http://localhost:8000 e testare esecuzione di una query che contiene commenti inline prima dello statement SELECT.

#### d) Verifica Schedulazioni (se modificate)

```powershell
$scheduling = (Get-Content "C:\PSTT_TOOL\connections.json" | ConvertFrom-Json).scheduling
Write-Host "Schedulazioni totali: $($scheduling.Count)"
$enabled = $scheduling | Where-Object { $_.enabled -eq $true }
Write-Host "Schedulazioni attive: $($enabled.Count)"
```

#### e) Verifica Log

```powershell
# Log applicazione (ultimi 50 messaggi)
Get-Content "C:\PSTT_TOOL\logs\app.log" -Tail 50

# Verifica assenza errori critici
$errors = Get-Content "C:\PSTT_TOOL\logs\app.log" -Tail 100 | Select-String "ERROR"
if ($errors.Count -gt 0) {
    Write-Warning "Trovati $($errors.Count) errori nei log recenti"
    $errors | Select-Object -First 5
} else {
    Write-Host "Nessun errore nei log recenti ‚úì" -ForegroundColor Green
}
```

## üîç Test Specifici v1.2.2

### Test Fix Parsing Commenti

1. **Crea query di test con commenti**:
   Creare file `C:\PSTT_TOOL\Query\Test\TEST-COMMENTS.sql`:
   ```sql
   define data_inizio = '2026-02-01'
   define data_fine = '2026-02-18'
   
   -- Questo √® un commento prima del SELECT
   /* Questo √® un
      commento multilinea */
   SELECT 
       SYSDATE as data_test,
       '&data_inizio' as param1,
       '&data_fine' as param2
   FROM DUAL
   ```

2. **Eseguire da UI**:
   - Aprire http://localhost:8000
   - Selezionare connessione di test
   - Selezionare query `TEST-COMMENTS.sql`
   - Compilare parametri
   - **Eseguire**: deve completare con successo

3. **Risultato atteso**: Query eseguita senza errori, risultati visualizzati

### Test Nuove Query PCL

1. **Verifica disponibilit√†**:
   ```powershell
   Get-ChildItem "C:\PSTT_TOOL\Query\Report" -Filter "CDG-PCL-*.sql"
   ```

2. **Test esecuzione manuale** (se credenziali disponibili):
   - Aprire http://localhost:8000
   - Selezionare `C00-CDG-Produzione` (o ambiente test)
   - Selezionare `CDG-PCL-001--Mazzetti DSX giornalieri - sintetico.sql`
   - Compilare parametri richiesti
   - Eseguire e verificare risultati

## üìä Rollback (se necessario)

Se si verificano problemi dopo l'aggiornamento:

```powershell
# 1. Stop servizio
Stop-Service -Name PSTT_Tool -Force

# 2. Ripristina backup
$backup = "C:\Backup\PSTT_TOOL_20260218_HHMMSS"  # Sostituire con timestamp effettivo
$dest = "C:\PSTT_TOOL"
robocopy $backup $dest /MIR /R:2 /W:2 /XD .venv __pycache__

# 3. Riavvia servizio
Start-Service -Name PSTT_Tool

# 4. Verifica versione (deve tornare a 1.2.1)
$health = Invoke-RestMethod -Uri "http://localhost:8000/api/monitoring/health"
Write-Host "Version dopo rollback: $($health.version)"
```

## üìã Checklist Post-Aggiornamento

- [ ] Servizio avviato correttamente (`Get-Service PSTT_Tool`)
- [ ] Health check positivo (versione 1.2.2)
- [ ] Nuove query PCL visibili in lista query
- [ ] Test esecuzione query con commenti inline OK
- [ ] Schedulazioni attive correttamente (se modificate)
- [ ] Nessun errore nei log applicazione
- [ ] Backup pre-aggiornamento conservato

## üÜò Troubleshooting

### Problema: Query con commenti continuano a dare errore

**Causa**: File non aggiornato correttamente

**Soluzione**:
```powershell
# Verifica hash file
$hash = (Get-FileHash "C:\PSTT_TOOL\app\services\query_service.py" -Algorithm MD5).Hash
Write-Host "Hash query_service.py: $hash"
# Confronta con hash file nel pacchetto sorgente
```

### Problema: Nuove query PCL non visibili

**Causa**: File non copiati o cartella Query non aggiornata

**Soluzione**:
```powershell
# Ricopia Query folder
robocopy "C:\Pacchetto\PSTT_TOOL\Query" "C:\PSTT_TOOL\Query" /E /R:2 /W:2
Restart-Service -Name PSTT_Tool
```

### Problema: Schedulazioni non funzionano dopo modifica connections.json

**Causa**: JSON non valido

**Soluzione**:
```powershell
# Valida JSON
try {
    $json = Get-Content "C:\PSTT_TOOL\connections.json" -Raw | ConvertFrom-Json
    Write-Host "JSON valido ‚úì"
} catch {
    Write-Error "JSON non valido: $_"
    # Ripristina connections.json dal backup
    Copy-Item "$backup\connections.json" "C:\PSTT_TOOL\connections.json" -Force
}
```

## üìû Supporto

Per problemi o domande sull'aggiornamento, contattare il team di sviluppo con:
- Log errori da `C:\PSTT_TOOL\logs\app.log`
- Output comando health check
- Descrizione del problema riscontrato

## üìù Note Tecniche

### Dettagli Fix Parsing Commenti

Il fix rimuove i commenti SQL (`--` inline e `/* */` block) prima di verificare se uno statement √® di tipo SELECT/WITH oppure DML/DDL. Questo risolve falsi positivi dove commenti prima di SELECT causavano esecuzione errata.

**Codice modificato** (`app/services/query_service.py`):
```python
# Rimuovi commenti prima del check SELECT
stmt_no_comments = re.sub(r'--[^\n]*', '', stmt)
stmt_no_comments = re.sub(r'/\*.*?\*/', '', stmt_no_comments, flags=re.DOTALL)
stmt_no_comments = stmt_no_comments.strip()
is_select = stmt_no_comments.lower().startswith("select") or stmt_no_comments.lower().startswith("with")
```

### Compatibilit√†

- ‚úÖ **Backward compatible**: Nessuna breaking change
- ‚úÖ **Database**: Nessuna modifica schema richiesta
- ‚úÖ **API**: Nessuna modifica endpoint
- ‚úÖ **Configurazione**: Solo modifiche opzionali a `connections.json`

---

**Fine documento Update R20260218**
