# Update R20260114

Aggiornamento relativo ai fix e miglioramenti su `feature/R20260113` (Settings API, robustezza scheduler, UI impostazioni).

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata.
- Percorso di installazione corrente della app (es.: `C:\PSTT_TOOL` o `C:\App\PSTT_TOOL`).
- Nome del Servizio Windows dell'applicazione (es.: `PSTT_Tool` o `PSTT TOOL`).
- Pacchetto sorgente aggiornato.

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (se presente):
```powershell
# Eseguire nella cartella di installazione
./manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_Tool -Force
Get-Service -Name PSTT_Tool
```

- SC.exe:
```cmd
sc stop PSTT_Tool
sc query PSTT_Tool
```

## 2) Backup installazione corrente
```powershell
$src = "C:\App\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-01-14"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
Copiare i file aggiornati nella cartella di installazione.

- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento con `robocopy` (esclusioni):
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\App\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Aree/moduli aggiornati in R20260114
- Backend: [app/api/settings.py](app/api/settings.py) — fix POST con rilettura `.env`, aggiornamento in‑place whitelestato, preserva credenziali DB.
- Frontend: [app/frontend/settings.html](app/frontend/settings.html) — messaggi salvataggio più chiari; ricarica valori dopo POST.
- Scheduler: [app/services/scheduler_service.py](app/services/scheduler_service.py) —
  - timeout `query/write` coerzionati a numeri positivi (float);
  - `scheduler_history.json` caricato in modo tollerante a file vuoti/corrotti con backup automatico;
  - salvataggio atomico della history in `exports/_tmp` + move.
- Documentazione: [CHANGELOG.md](CHANGELOG.md), [README.md](README.md).

## 4) Eccezioni: aggiornare `connections.json` e `.env` solo se necessario
Questi file **non vanno sovrascritti** automaticamente.

### 4.1 `connections.json`
- Se devi allineare orari/minuti/secondi o la `end_date` di alcune schedulazioni di esempio, applica le modifiche manualmente verificando che il JSON resti valido:
```powershell
$path = "C:\App\PSTT_TOOL\connections.json"
Get-Content $path -Raw | ConvertFrom-Json | Out-Null; Write-Host "connections.json valido"
```

### 4.2 `.env`
- Nessun nuovo parametro obbligatorio.
- Se vuoi modificare i timeout dello scheduler, assicurati che esistano (o aggiungili):
```
scheduler_query_timeout_sec=900
scheduler_write_timeout_sec=120
```
- Puoi aggiornarli dalla UI (Impostazioni) — l'API scrive in‑place solo le chiavi consentite e **non tocca mai** `DB_USER_*`/`DB_PASS_*`.

## 5) Aggiornamento dipendenze (se necessario)
Confronta `requirements.txt`; se variato:
```powershell
C:\App\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\App\PSTT_TOOL\requirements.txt
```

## 6) Avvio del Servizio
- Script:
```powershell
./manage_service.ps1 start
```
- PowerShell:
```powershell
Start-Service -Name PSTT_Tool
Get-Service -Name PSTT_Tool
```
- SC.exe:
```cmd
sc start PSTT_Tool
sc query PSTT_Tool
```

## 7) Verifiche post-deploy
- UI Impostazioni: salvataggio timeout/SMTP senza errore e valori aggiornati visibili subito.
- Riavvio: `POST /api/system/restart` dall'UI mostra overlay e il servizio torna operativo.
- Scheduler: nessun errore di tipo con i timeout; la history viene scritta e letta correttamente; eventuali file corrotti vengono backupati.

## 8) Rollback
```powershell
Stop-Service -Name PSTT_Tool -Force
robocopy "C:\Backup\PSTT_TOOL_2026-01-14" "C:\App\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_Tool
```

## Note operative
- Evita sempre la sovrascrittura di `connections.json` e `.env` in produzione/collaudo.
- Documenta eventuali personalizzazioni locali e conserva backup e pacchetto sorgente.