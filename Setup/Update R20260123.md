# Update R20260123

- Aggiornamento relativo ai lavori su branch `feature/R20260122`: allineamento metriche Kafka in dashboard, pannello Consumer Rapido con diagnostica topic, miglioramenti di usabilità e fix minori.
- Obiettivo: migliorare visibilità e utilizzo Kafka da UI, fornire strumenti di diagnostica rapida e rendere chiari gli stati di connessione.

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata.
- Percorso installazione corrente dell'app (es.: `C:\PSTT_TOOL`).
- Nome del Servizio Windows (es.: `PSTT_TOOL`).
- Pacchetto sorgente aggiornato con i seguenti percorsi da allineare.

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (se presente nella root):
```powershell
# Eseguire nella cartella di installazione
./manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
Creare una copia di sicurezza:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-01-23"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento con `robocopy`:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Elenco aree con modifiche (R20260123)
- Frontend:
  - `app/templates/kafka_dashboard.html` — pannello Consumer Rapido sotto Gestione Connessioni; stato pulsanti chiaro (disabilitato/verde su connessione attiva); filtri periodo e drill‑down; suggerimenti topic via datalist.
- Backend/API:
  - `app/api/kafka.py` — `/api/kafka/consume` aggiornata: rispetto parametro `period` (seek `latest`/`earliest`), timeout aumentati; nuovo endpoint `/api/kafka/topic-info/{topic}` per diagnostica partizioni/offset.
- Tools:
  - `tools/create_kafka_deploy_package.ps1` — rimossa variabile non utilizzata per eliminare warning analyzer.
- Documentazione:
  - `docs/CHANGELOG.md` — aggiunta voce [1.1.1] con dettagli.
  - `docs/README.md` — aggiornato badge versione e sezione Dashboard Kafka.

#### Dettaglio file da sovrascrivere
- `app/templates/kafka_dashboard.html`
- `app/api/kafka.py`
- `docs/CHANGELOG.md`
- `docs/README.md`
- `tools/create_kafka_deploy_package.ps1`

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Applicare solo verifiche:

### 4.1 `connections.json`
- Verificare che l'eventuale sezione `kafka_connections` sia valida e punti ai broker corretti.
- Non sono richieste nuove chiavi per questa release.

### 4.2 `.env`
- Nessun nuovo parametro obbligatorio.
- Se presente configurazione Kafka in produzione, verificare le variabili `KAFKA_*` già documentate in `docs/KAFKA_SETUP.md`.

## 5) Aggiornamento dipendenze (se necessario)
- Confrontare `requirements.txt`. Nessuna dipendenza nuova rispetto a 1.1.0.

## 6) Avvio del Servizio
- Script di gestione:
```powershell
./manage_service.ps1 start
```

- PowerShell nativo:
```powershell
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc start PSTT_TOOL
sc query PSTT_TOOL
```

## 7) Verifiche post-deploy
- Dashboard Kafka:
  - Metriche allineate (riepilogo/ultimo 24h/breakdown per topic) con filtri e drill‑down.
  - Pulsante "Leggi Messaggi" inizialmente disabilitato; diventa verde dopo test connessione.
  - "Consumer Rapido": selezione `latest`/`earliest`, lettura ultimi messaggi.
  - "Info Topic": restituisce partizioni e range offset; gestisce 404 se topic non esiste/ACL insufficienti.
- Log applicativi: assenza di errori durante test connessione e consumo.

## 8) Rollback
In caso di problemi:
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2026-01-23" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- Evitare la sovrascrittura di `connections.json` e `.env`.
- Documentare eventuali personalizzazioni locali prima dell'aggiornamento.
- Archiviare pacchetto sorgente e backup per riferimento futuro.
