# Update R20260107

- Aggiornamento relativo all'introduzione del Log Viewer (UI + API) e semplificazioni UI Scheduler (prefill soggetto/corpo email in Modifica), senza impatti su connections.json/.env.

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata.
- Percorso di installazione corrente della app (es.: `C:\PSTT_TOOL`).
- Nome del Servizio Windows dell'applicazione (es.: `PSTT_TOOL`).
- Pacchetto sorgente aggiornato (cartelle `app/`, `templates/`, `static/`, `frontend/`, `core/`, `services/`, `api/`, `Query/`, `CHANGELOG.md`, ecc.).

## 1) Stop del Servizio
```powershell
# Script di gestione (se presente)
./manage_service.ps1 stop
# Oppure PowerShell nativo
Stop-Service -Name PSTT_TOOL -Force
Get-Service -Name PSTT_TOOL
# Oppure SC.exe
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-01-07"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento con `robocopy`:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Elenco aree con modifiche in R20260107
- Frontend: `app/frontend/logs.html` (nuova pagina), semplificazioni in `app/frontend/scheduler_dashboard.html` (prefill soggetto/corpo email in Modifica quando vuoti o passando alla modalità Email).
- Backend: `app/api/logs.py` (nuovo router API per lettura log odierni e archiviati/compressi), `app/main.py` (registrazione router logs e route `/logs`).
- Documentazione: `CHANGELOG.md`, `README.md` (sezione Log Viewer).
 - Template: `app/templates/index.html` (aggiunto link "Log" in navigazione).
 - Reports: `app/services/daily_report_service.py` (nuovo servizio), `app/api/reports.py` (preview e invio), `app/main.py` (registrazione router `/api/reports`).

#### Dettaglio file da sovrascrivere (estensione 2026-01-07)
- `app/api/logs.py` — API: `GET /api/logs/list`, `GET /api/logs/read-today`, `GET /api/logs/read`.
- `app/frontend/logs.html` — visualizzatore log in sola lettura (supporto `.gz`).
- `app/main.py` — aggiunta `app.include_router(logs_api.router, ...)` e route HTML `/logs`.
- `app/frontend/scheduler_dashboard.html` — precompilazione default oggetto/corpo email anche in Modifica.
 - `app/templates/index.html` — aggiunto link "Log" in navigazione (accesso rapido al Log Viewer).
 - `app/services/daily_report_service.py` — generazione e invio report giornaliero (destinatari separati da pipe `|`).
 - `app/api/reports.py` — API: `GET /api/reports/daily`, `POST /api/reports/daily/send`.
 - `app/core/config.py` — nuove chiavi `.env` per report giornaliero (abilitazione, cron/ora, destinatari pipe, subject).

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Applicare invece le seguenti verifiche/modifiche:

### 4.1 `connections.json`
- Nessuna modifica obbligatoria per R20260107.
- Verificare che le schedulazioni correnti mantengano il comportamento atteso (delete per indice, filtro query per connessione).

### 4.2 `.env`
- Nessuna nuova variabile obbligatoria in R20260107.
- Confermare i parametri runtime se la UI è pubblicata dietro reverse proxy (IIS/ARR):
```bash
HOST=127.0.0.1
PORT=8001
DEBUG=false
LOG_LEVEL=INFO
```

## 5) Aggiornamento dipendenze (se necessario)
- Confrontare `requirements.txt`. Per questa release non sono previsti nuovi pacchetti.
- Se necessario:
```powershell
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

## 6) Avvio del Servizio
```powershell
./manage_service.ps1 start
# Oppure
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
# Oppure
sc start PSTT_TOOL
sc query PSTT_TOOL
```

## 7) Verifiche post-deploy
- Log Viewer:
  - Apri `/logs`, verifica che il select mostri anche gli archivi compressi (`.gz`).
  - Cambia file e, se necessario, imposta `Tail` per visualizzare solo le ultime N righe.
- Scheduler UI:
  - In Modifica, passando a "Email" o con campi vuoti, oggetto/corpo si precompilano con i default.
- Reverse proxy (se presente):
  - Nessun errore 502/504; timeout ARR coerente con timeout applicativo.

## 8) Rollback
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2026-01-07" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- Non sovrascrivere `connections.json` e `.env`.
- Documentare eventuali personalizzazioni locali prima dell’aggiornamento.
- Archiviare il pacchetto sorgente e il backup per riferimento futuro.
