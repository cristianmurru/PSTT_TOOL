# Update R20260112

- Aggiornamento relativo ai lavori su "feature/R20260109": supporto secondi nello scheduling, UX di riavvio servizio, persistenza `.env` migliorata e pulizia automatica dei test.

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata.
- Installazione corrente dell’app come Servizio Windows (NSSM) su collaudo/produzione, oppure avvio via terminale con `start_pstt.bat`.
- Pacchetto sorgente aggiornato (cartella `app/`, `main.py`, `templates/`, `static/`, `services/`, `core/`, `Query/`, `CHANGELOG.md`, `README.md`, ecc.).

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (se presente nella root):
```powershell
./manage_service.ps1 -Action stop -ServiceName PSTT_TOOL
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
Esegui un backup della cartella di installazione:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-01-12"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copia i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento (escludendo esplicitamente):
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Aree/moduli toccati in R20260112
- Frontend Settings: overlay di riavvio, pulsante "Riavvia App", campi timeout.
- Frontend Scheduler: campo opzionale `second`, abilitazione/disabilitazione coerente dei campi in funzione della modalità.
- Backend Settings API: writer `.env` ristrutturato per includere i nuovi timeout e rispettare il template atteso, mantenendo chiavi non gestite.
- Backend System API: nuovo endpoint `POST /api/system/restart` per riavvio come servizio o pianificato via batch.
- Scheduler Service: trigger `classic` con supporto del `second`.

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Applicare invece le seguenti verifiche/modifiche:

### 4.1 `connections.json`
- Verifica che il JSON sia valido e coerente con la struttura attesa.
- Nessuna modifica obbligatoria introdotta da R20260112; mantenere connessioni e scheduling locali come da esigenza.

### 4.2 `.env`
- Verifica credenziali e parametri esistenti.
- Se assenti, aggiungi i nuovi timeout (valori consigliati):
  - `scheduler_query_timeout_sec=900`
  - `scheduler_write_timeout_sec=120`
- La pagina `/settings` ora supporta la modifica di questi timeout e riscrive `.env` mantenendo le altre chiavi. Alcune modifiche richiedono riavvio del servizio per riflettersi nello scheduler.

## 5) Aggiornamento dipendenze (se necessario)
Confronta `requirements.txt` con la versione precedente ed aggiorna l’ambiente Python solo se sono variate le dipendenze:
```powershell
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

## 6) Avvio del Servizio
- Script di gestione:
```powershell
./manage_service.ps1 -Action start -ServiceName PSTT_TOOL
```
- PowerShell nativo:
```powershell
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
```
- SC.exe:
```cmd
sc start PSTT_TOOL
sc query PSTT_TOOL
```

## 7) Verifiche post‑deploy
- Settings: apri `/settings`, verifica presenza dei campi timeout e funzionalità del pulsante “Riavvia App” (overlay mostra down/up; l’app torna operativa e la pagina si ricarica).
- Scheduler: in modalità `classic` verifica che sia possibile impostare i secondi (facoltativo) e che i campi siano disabilitati correttamente quando passi a `cron`.
- `.env`: dopo un salvataggio da UI, i valori restano persistenti e la struttura è quella attesa (chiavi non gestite preservate).
- Test: opzionale, esegui la suite `pytest` in ambiente di staging per confermare assenza di regressioni.

## 8) Riavvio da UI e da API
- UI: pulsante “Riavvia App” in `/settings` con overlay di stato.
- API: `POST /api/system/restart` — se il servizio NSSM è presente viene riavviato; in fallback viene avviato `start_pstt.bat` e il processo corrente termina.

## 9) Rollback
In caso di problemi:
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2026-01-12" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- Non sovrascrivere `connections.json` e `.env`: aggiorna solo le parti necessarie.
- Documenta eventuali personalizzazioni locali prima dell’intervento.
- In caso di problemi di avvio dovuti a porta in uso, verifica `PORT` in `.env` e lo stato del servizio/istanza che occupa la porta.