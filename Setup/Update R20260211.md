# Update R20260211

- **Versione**: 1.2.1
- **Data**: 2026-02-11
- **Branch**: feature/R20260211
- **Tipo intervento**: Fix critico produzione + Feature sicurezza

## üìã Sommario Modifiche

### Fix Critici
1. **Oracle Connection Pool Stale Connections** (üî• PRIORIT√Ä ALTA)
   - Risolto problema timeout notturni schedulazioni (tutte le schedulazioni andavano in timeout 1200s)
   - Abilitato `pool_pre_ping` per validazione connessioni prima dell'uso
   - Ridotto `pool_recycle` da 3600s a 1800s
   - Aggiunto cleanup esplicito connessioni dopo timeout

2. **Versione dinamica da CHANGELOG**
   - `app_version` estratta automaticamente da CHANGELOG.md
   - Elimina necessit√† aggiornamento manuale versione nel codice

### Nuove Feature
3. **Controllo visibilit√† riavvio app in produzione**
   - Variabile `ENABLE_APP_RESTART` per disabilitare riavvio self-service
   - Protezione backend (HTTP 403) e frontend (pulsante disabilitato)

## Prerequisiti
- Accesso al server con privilegi amministrativi
- Finestra di manutenzione concordata (downtime: ~5 minuti)
- Percorso installazione: `C:\PSTT_TOOL` (o equivalente)
- Nome servizio Windows: `PSTT_TOOL`
- Pacchetto sorgente aggiornato dalla cartella di release

## üö® Impatto e Urgenza

**Severit√†**: ALTA  
**Ambiente**: COLLAUDO e PRODUZIONE  
**Downtime**: ~5 minuti  

**Motivazione**: Fix critico per timeout notturni schedulazioni in produzione. Senza questo fix, tutte le schedulazioni notturne continuano a fallire con timeout 1200s.

## üì¶ File Modificati

### Backend Core
- `app/core/config.py` ‚Üí Versione dinamica da CHANGELOG + setting `enable_app_restart`
- `app/services/connection_service.py` ‚Üí Pool configuration fix (pool_pre_ping, pool_recycle)
- `app/services/scheduler_service.py` ‚Üí Cleanup connessioni dopo timeout
- `app/api/system.py` ‚Üí Endpoint `/restart/enabled` + protezione `/restart`

### Frontend
- `app/templates/settings.html` ‚Üí Controllo dinamico visibilit√† pulsante riavvio

### Documentazione
- `docs/CHANGELOG.md` ‚Üí Aggiunta versione 1.2.1
- `docs/TROUBLESHOOTING.md` ‚Üí Nuova sezione "Timeout query schedulazioni notturne (Stale Connections)"

### Test
- `tests/test_system_restart.py` ‚Üí Aggiunti test per feature `enable_app_restart`

### File .env.example
- `.env.example` ‚Üí Aggiunta variabile `ENABLE_APP_RESTART`

## üìù Procedura Aggiornamento

### 1) Stop del Servizio

```powershell
# Opzione 1: Script gestione
cd C:\PSTT_TOOL
.\manage_service.ps1 stop

# Opzione 2: PowerShell nativo
Stop-Service -Name PSTT_TOOL -Force

# Verifica stato
Get-Service -Name PSTT_TOOL
# Status deve essere: Stopped
```

### 2) Backup Installazione Corrente

```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2 /XD .venv __pycache__

Write-Host "Backup completato in: $dst" -ForegroundColor Green
```

### 3) Sovrascrittura File Aggiornati

**‚ö†Ô∏è IMPORTANTE: NON sovrascrivere**:
- `connections.json`
- `.env`

```powershell
# Copia file aggiornati (esclusi connections.json e .env)
$source = "C:\Pacchetto\PSTT_TOOL"  # Percorso pacchetto sorgente
$dest = "C:\PSTT_TOOL"

# Copia con esclusioni
robocopy "$source\app" "$dest\app" /E /R:2 /W:2
robocopy "$source\docs" "$dest\docs" /E /R:2 /W:2  
robocopy "$source\tests" "$dest\tests" /E /R:2 /W:2
robocopy "$source\Setup" "$dest\Setup" /E /R:2 /W:2

# File root (esclusi .env e connections.json)
Copy-Item "$source\main.py" "$dest\main.py" -Force
Copy-Item "$source\requirements.txt" "$dest\requirements.txt" -Force
Copy-Item "$source\pytest.ini" "$dest\pytest.ini" -Force
Copy-Item "$source\.env.example" "$dest\.env.example" -Force
```

### 4) Configurazione .env (Nuova Variabile)

Modificare manualmente il file `.env` aggiungendo:

```env
# ============================================
# CONTROLLO RIAVVIO APP (v1.2.1)
# ============================================
# Abilita/disabilita pulsante "Riavvia App" in Settings
# PRODUZIONE: impostare a false per sicurezza
# COLLAUDO/SVILUPPO: impostare a true
ENABLE_APP_RESTART=false
```

**Valori consigliati**:
- **PRODUZIONE**: `ENABLE_APP_RESTART=false` (disabilita riavvio self-service)
- **COLLAUDO**: `ENABLE_APP_RESTART=true` (abilita riavvio per test)
- **SVILUPPO**: `ENABLE_APP_RESTART=true`

### 5) Verifica connections.json

**Nessuna modifica richiesta** al file `connections.json`.  
Il fix delle connessioni stale √® applicato a livello di connection pool (hardcoded in `connection_service.py`).

Esegui validazione JSON:
```powershell
$path = "C:\PSTT_TOOL\connections.json"
Get-Content $path -Raw | ConvertFrom-Json | Out-Null
Write-Host "connections.json valido ‚úì" -ForegroundColor Green
```

### 6) Aggiornamento Dipendenze

```powershell
cd C:\PSTT_TOOL
.\.venv\Scripts\Activate.ps1

# Verifica differenze requirements
pip list --outdated

# Aggiorna solo se necessario (non obbligatorio per R20260211)
# pip install -r requirements.txt --upgrade
```

**Nota**: R20260211 non introduce nuove dipendenze.

### 7) Riavvio Servizio

```powershell
# Opzione 1: Script gestione
.\manage_service.ps1 start

# Opzione 2: PowerShell nativo
Start-Service -Name PSTT_TOOL

# Verifica stato
Get-Service -Name PSTT_TOOL
# Status deve essere: Running
```

Attendi 10 secondi per startup completo.

### 8) Verifica Post-Installazione

#### 8.1 Health Check
```powershell
# Test connettivit√†
Invoke-RestMethod -Uri 'http://localhost:8000/api/monitoring/health'

# Output atteso:
# {
#   "status": "healthy",
#   "version": "1.2.1",  ‚Üê Verifica versione
#   "timestamp": "2026-02-11T..."
# }
```

#### 8.2 Verifica Pool Pre-Ping Abilitato
```powershell
# Cerca conferma pool_pre_ping nei log
Get-Content C:\PSTT_TOOL\logs\app.log -Tail 100 | Select-String "pool_pre_ping"

# Output atteso:
# 2026-02-11 ... | INFO | pool_pre_ping: True, pool_recycle: 1800s
```

#### 8.3 Test Riavvio App Disabilitato (Produzione)
```powershell
# Se ENABLE_APP_RESTART=false
Invoke-RestMethod -Uri 'http://localhost:8000/api/system/restart/enabled'

# Output atteso:
# {
#   "enabled": false,
#   "message": "Riavvio disabilitato in .env"
# }

# Test protezione endpoint
Invoke-RestMethod -Uri 'http://localhost:8000/api/system/restart' -Method POST

# Output atteso: HTTP 403 Forbidden
# {
#   "detail": "Il riavvio dell'applicazione √® disabilitato..."
# }
```

#### 8.4 Verifica UI
Accedi a http://localhost:8000/settings

**Controlli**:
1. In alto a destra: versione mostrata = `v1.2.1`
2. Pulsante "Riavvia App":
   - Se `ENABLE_APP_RESTART=false` ‚Üí pulsante disabilitato (opacit√† 50%), tooltip: "Riavvio disabilitato in configurazione"
   - Se `ENABLE_APP_RESTART=true` ‚Üí pulsante abilitato

#### 8.5 Monitora Schedulazioni Overnight

```powershell
# Monitora log scheduler per verificare assenza timeout
Get-Content C:\PSTT_TOOL\logs\scheduler.log -Wait | Select-String "TIMEOUT|SUCCESS"

# Dopo 24-48 ore, verifica che non ci siano pi√π timeout notturni
Get-Content C:\PSTT_TOOL\logs\scheduler.log | Select-String "TIMEOUT_QUERY" | 
    Select-Object -Last 10
```

**Risultato atteso**: Nessun timeout dopo applicazione fix.

## üîç Test di Regressione

Opzionale, solo in COLLAUDO:

```powershell
cd C:\PSTT_TOOL
.\.venv\Scripts\Activate.ps1

# Esegui suite test (escludi manuali)
python -m pytest -v -m "not manual" --tb=short

# Risultato atteso: 223+ test passati (1 test retry potrebbe fallire, √® preesistente)
```

## üîÑ Rollback

In caso di problemi critici:

```powershell
# 1. Stop servizio
Stop-Service -Name PSTT_TOOL -Force

# 2. Ripristina backup
$backup = "C:\Backup\PSTT_TOOL_<timestamp>"
robocopy $backup "C:\PSTT_TOOL" /MIR /R:2 /W:2

# 3. Restart servizio
Start-Service -Name PSTT_TOOL

# 4. Verifica
Get-Service -Name PSTT_TOOL
Invoke-RestMethod -Uri 'http://localhost:8000/api/monitoring/health'
```

## üìä Checklist Post-Implementazione

### Ambiente COLLAUDO
- [ ] Servizio riavviato correttamente
- [ ] Health check ritorna `"version": "1.2.1"`
- [ ] Log confermano `pool_pre_ping: True`
- [ ] Endpoint `/restart/enabled` funziona
- [ ] UI mostra versione `v1.2.1`
- [ ] Pulsante riavvio risponde a configurazione `ENABLE_APP_RESTART`
- [ ] Schedulazioni test eseguono senza timeout

### Ambiente PRODUZIONE
- [ ] Backup pre-intervento completato
- [ ] Servizio riavviato correttamente
- [ ] Health check ritorna `"version": "1.2.1"`
- [ ] Log confermano `pool_pre_ping: True`
- [ ] `.env` contiene `ENABLE_APP_RESTART=false`
- [ ] Endpoint `/restart` ritorna HTTP 403
- [ ] UI mostra pulsante riavvio disabilitato
- [ ] Monitoraggio schedulazioni notturne attivo
- [ ] Dopo 24h: verificare assenza timeout schedulazioni

## üìû Supporto

In caso di problemi:

1. **Verifica log applicazione**:
   ```powershell
   Get-Content C:\PSTT_TOOL\logs\app.log -Tail 50
   Get-Content C:\PSTT_TOOL\logs\scheduler.log -Tail 50
   ```

2. **Verifica stato servizio**:
   ```powershell
   Get-Service -Name PSTT_TOOL
   Get-EventLog -LogName Application -Source PSTT_TOOL -Newest 20
   ```

3. **Contatta sviluppatore** con:
   - Log completo (app.log + scheduler.log)
   - Output health check
   - Descrizione del problema
   - Ambiente (COLLAUDO/PRODUZIONE)

## üéØ Note Finali

- **Tempo stimato intervento**: 10-15 minuti
- **Downtime effettivo**: ~5 minuti
- **Rischio**: BASSO (modifiche isolate, backward compatible)
- **Benefici**:
  - ‚úÖ Risolto problema critico timeout notturni
  - ‚úÖ Connessioni database pi√π robuste
  - ‚úÖ Controllo sicurezza riavvio produzione
  - ‚úÖ Versione automaticamente allineata a CHANGELOG

---

**Document Version**: 1.0  
**Prepared by**: Automated Release Process  
**Date**: 2026-02-11
