# Update R20260127

- Aggiornamento relativo ai commit e modifiche su branch `feature/R20260123` (menu Aiuto globale, viewer Markdown, chiarimenti storico scheduler, fix persistenza campi Kafka, ottimizzazioni UI).
- Obiettivo: distribuire gli aggiornamenti su ambienti di collaudo e produzione mantenendo configurazioni locali (`connections.json`, `.env`).

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata.
- Percorso di installazione corrente della app (es.: `C:\PSTT_TOOL` o equivalente).
- Nome del Servizio Windows dell'applicazione (es.: `PSTT_TOOL`).
- Pacchetto sorgente aggiornato contenente le directory `app/`, `templates/`, `static/`, `frontend/`, `services/`, `core/`, `Query/`, `docs/`.

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (se presente nella root):
```powershell
# Eseguire nella cartella di installazione
./manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
Creare una copia di sicurezza dell'installazione:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-01-27"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento: se usi `robocopy`, escludi esplicitamente:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Elenco aree con modifiche in R20260127
- Frontend:
  - `app/templates/index.html` — aggiunta icona "?" (menu Aiuto) con link README/CHANGELOG.
  - `app/frontend/scheduler_dashboard.html` — fix toggle Aiuto, semplificazione storico (rimozione badge), precompilazione corretta `kafka_topic`/`kafka_key_field` in edit.
  - `app/frontend/logs.html` e `app/frontend/settings.html` — menu Aiuto e toggle uniformati.
  - `app/templates/kafka_dashboard.html` — menu Aiuto e script toggle.
  - `app/templates/markdown_viewer.html` — viewer Markdown stile GitHub, evidenziazione codice, ricerca.
- Backend/API:
  - `app/main.py` — route: `GET /docs/readme`, `GET /docs/changelog` (fallback README, normalizzazione headings).
  - `app/api/scheduler.py` — normalizzazione cron 6→5 campi, storico ultimi 30 giorni, salvataggio schedulazioni.
  - `app/services/scheduler_service.py` — registrazione esplicita timeout query/scrittura nello storico; mantenimento `export_mode`.
- Documentazione:
  - `docs/README.md` — sezione Aiuto/Documentazione aggiornata.
  - `docs/CHANGELOG.md` — nuova voce 1.1.1 con dettagli.

#### Dettaglio file da sovrascrivere (consigliato)
- `app/frontend/scheduler_dashboard.html`
- `app/templates/index.html`
- `app/templates/kafka_dashboard.html`
- `app/frontend/logs.html`
- `app/frontend/settings.html`
- `app/templates/markdown_viewer.html`
- `app/main.py`
- `app/api/scheduler.py`
- `app/services/scheduler_service.py`
- `docs/README.md`
- `docs/CHANGELOG.md`

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Applicare invece le seguenti verifiche/modifiche:

### 4.1 `connections.json`
- Verificare che la sezione `kafka_connections` sia presente e coerente se si intende usare l'export Kafka.
- Validare il JSON:
```powershell
$path = "C:\PSTT_TOOL\connections.json"
Get-Content $path -Raw | ConvertFrom-Json | Out-Null; Write-Host "connections.json valido"
```

### 4.2 `.env`
- Nessun nuovo parametro obbligatorio introdotto da R20260127.
- Se si usa Kafka in produzione, assicurarsi della presenza delle credenziali e parametri (es. `KAFKA_PROD_PASSWORD`).

## 5) Aggiornamento dipendenze (se necessario)
- Non sono state aggiunte nuove dipendenze oltre a quelle già previste per Kafka/Viewer.
- Se il server non ha accesso internet, preparare pacchetti wheel offline.
```powershell
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

## 6) Avvio del Servizio
- Script di gestione:
```powershell
./manage_service.ps1 start
```

- PowerShell nativo:
```powershell
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc start PSTT_TOOL
sc query PSTT_TOOL
```

## 7) Verifiche post-deploy
- **Menu Aiuto**: icona "?" presente su tutte le pagine; apertura/chiusura corretta, link README/CHANGELOG funzionanti.
- **Viewer Markdown**: stile coerente, evidenziazione codice, ricerca parola chiave.
- **Storico Scheduler**: visualizza messaggi di timeout espliciti; UI senza badge extra.
- **Kafka in Edit**: i campi `kafka_topic` e `kafka_key_field` risultano precompilati e vengono salvati correttamente.
- **Cron 5 campi**: verifica che le nuove schedulazioni usino formato a 5 campi (minuto, ora, giorno, mese, giorno‑settimana).

## 8) Rollback
In caso di problemi:
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2026-01-27" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- Non sovrascrivere `connections.json` e `.env`.
- Documentare eventuali personalizzazioni locali.
- Archiviare pacchetto sorgente e backup per riferimento futuro.
