# Update R20260210 - Parametri Lista e Robustezza Scheduler

**Release**: v1.2.0  
**Data**: 2026-02-10  
**Branch**: feature/R20260209

## Sommario modifiche

Questo aggiornamento introduce:
- ✅ **Parametri lista intelligenti**: gestione automatica di elenchi fino a 1000 elementi con UI dedicata
- ✅ **Multi-formato input**: supporto virgola, newline, già formattati, doppi apici
- ✅ **Validazione live**: contatore elementi e highlight errori in tempo reale
- ✅ **Query multi-statement robuste**: supporto completo `ALTER SESSION` e preamble SQL
- ✅ **Robustezza scheduler**: parametri `coalesce` e `misfire_grace_time` configurabili
- ✅ **Test estesi**: +20 test per parametri lista (225 test totali, 100% pass)

## Prerequisiti

- Accesso al server con privilegi amministrativi
- Finestra di manutenzione concordata (utente non operativo durante l'intervento)
- Percorso di installazione corrente (es.: `C:\App\PSTT_TOOL` o `C:\PSTT_TOOL`)
- Nome del Servizio Windows (es.: `PSTT_Tool` o `PSTT_TOOL`)
- Pacchetto sorgente aggiornato (da repository branch `feature/R20260209` o merge su `master`)

## 1) Stop del Servizio

Scegli una delle opzioni:

**Script di gestione** (consigliato):
```powershell
# Eseguire nella cartella di installazione
.\tools\manage_service.ps1 stop
```

**PowerShell nativo**:
```powershell
Stop-Service -Name PSTT_Tool -Force
Get-Service -Name PSTT_Tool  # Verifica stato = Stopped
```

**SC.exe**:
```cmd
sc stop PSTT_Tool
sc query PSTT_Tool
```

## 2) Backup installazione corrente

Creare una copia di sicurezza dell'installazione:
```powershell
$src = "C:\App\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-02-10"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2

# Verifica backup completato
Write-Host "Backup completato in $dst" -ForegroundColor Green
```

## 3) Sovrascrittura file aggiornati

### Esclusioni obbligatorie
**Non sovrascrivere**:
- `connections.json` (configurazione connessioni e schedulazioni)
- `.env` (credenziali e parametri ambiente)

### Comando robocopy consigliato
```powershell
$pacchetto = "C:\Pacchetto\PSTT_TOOL"  # Path sorgente aggiornato
$target = "C:\App\PSTT_TOOL"           # Path installazione
robocopy $pacchetto $target /MIR /R:2 /W:2 /XD .venv logs exports /XF connections.json .env

# Verifica copia completata
Write-Host "Aggiornamento file completato" -ForegroundColor Green
```

### Aree con modifiche principali (R20260210)

#### Backend/Core
- `app/services/query_service.py` — metodo `_format_list_parameter()`, multi-statement handling, substitution logic
- `app/services/scheduler_service.py` — robustezza: misfire, coalesce, daily report reload fix
- `app/api/scheduler.py` — helper `_to_int()`, applicazione settings robustezza a tutti job
- `app/api/settings.py` — nuove chiavi: `scheduler_coalesce_enabled`, `scheduler_misfire_grace_time_sec`
- `app/core/config.py` — nuovi campi Settings per robustezza scheduler

#### Frontend/UI
- `app/static/js/main.js` — textarea rendering, validazione live, pre-execution check per parametri lista
- `app/templates/index.html` — attributo `data-app-env` per controlli ambiente
- `app/templates/settings.html` — sezione "Robustezza Scheduler" con input coalesce e misfire

#### Query SQL
- `Query/Affari Legali/CDG-AL-002--Estrati Tracciatura - tracciato AEG.sql` — `BARCODE_LIST` + preamble `ALTER SESSION`
- `Query/Informative/CDG-INF-001,002,004` — normalizzazione uppercase keywords
- `Query/Informative/CDG-INF-005--Estrai tracciatura spedizione - test.sql` — nuovo file test
- `Query/Affari Legali/CDG-AL-001--Estrai spedizioni da Anagrafica.sql` — ripristinato (precedentemente eliminato)

#### Documentazione
- `docs/CHANGELOG.md` — voce v1.2.0 con dettaglio completo modifiche
- `docs/README.md` — sezione "Parametri Lista" con esempi e naming pattern
- `docs/TROUBLESHOOTING.md` — sezione "Errori Parametri Lista Query" con diagnostica

#### Tests
- `tests/test_list_parameters.py` — 20 nuovi test per parametri lista (formati, validazione, substitution)

## 4) Eccezioni: aggiornare `connections.json`

Il file **non va sovrascritto**, ma potrebbero essere necessarie modifiche manuali.

### 4.1 Verifica JSON valido
```powershell
$path = "C:\App\PSTT_TOOL\connections.json"
try {
    Get-Content $path -Raw | ConvertFrom-Json | Out-Null
    Write-Host "✅ connections.json valido" -ForegroundColor Green
} catch {
    Write-Host "❌ connections.json NON valido: $_" -ForegroundColor Red
}
```

### 4.2 Cleanup schedulazioni test (opzionale)
Se presenti schedulazioni di test obsolete, rimuoverle:

1. **Backup corrente**:
   ```powershell
   Copy-Item $path "$path.bak_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
   ```

2. **Rimuovere manualmente** schedulazioni con:
   - `description` contenente "test" o "TEST"
   - `enabled = false` e non più necessarie
   - Query obsolete (es. `CDG-DSX-001` se non più utilizzata)

3. **Rivalidare** JSON dopo modifiche:
   ```powershell
   Get-Content $path -Raw | ConvertFrom-Json | ConvertTo-Json -Depth 10 | Set-Content "$path.formatted"
   # Confronta manualmente .formatted con originale
   ```

### 4.3 Normalizzazione query SQL (opzionale)
Se le query esistenti usano parametri lista ma NON seguono il naming pattern, rinominarle:

**Prima** (non riconosciuto):
```sql
define BARCODE = '123,456'
WHERE barcode IN (&BARCODE)
```

**Dopo** (riconosciuto):
```sql
define BARCODE_LIST = '123,456'
WHERE barcode IN (&BARCODE_LIST)
```

Pattern riconosciuti (case-insensitive): `*LIST`, `*CODES`, `*BARCODES`, `*IDS`

## 5) Eccezioni: aggiornare `.env`

Il file **non va sovrascritto**. Verificare configurazioni esistenti.

### 5.1 Nuovi parametri opzionali (default già impostati)

Questi parametri hanno default ragionevoli in `app/core/config.py` e **non richiedono** modifiche al `.env`:

- `scheduler_coalesce_enabled=true` — accorpa esecuzioni perse (default OK)
- `scheduler_misfire_grace_time_sec=900` — finestra tolleranza 15 min (default OK)

### 5.2 Parametri esistenti da verificare

Assicurarsi che siano configurati (già richiesti da versioni precedenti):

```env
# SMTP per invio email (schedulazioni email)
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=pstt@example.com
SMTP_PASSWORD=your_secure_password
SMTP_FROM=pstt@example.com

# Database credenziali (già configurate)
ORACLE_PASSWORD=${ORACLE_PASSWORD}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

# Kafka credenziali (se usato)
KAFKA_SASL_PASSWORD=${KAFKA_PROD_PASSWORD}
```

### 5.3 Personalizzare robustezza scheduler (opzionale)

Se si desidera modificare il comportamento scheduler:

```env
# Disabilita accorpamento esecuzioni perse (sconsigliato)
SCHEDULER_COALESCE_ENABLED=false

# Aumenta finestra tolleranza a 30 minuti
SCHEDULER_MISFIRE_GRACE_TIME_SEC=1800
```

**Nota**: modifiche applicabili da UI Impostazioni dopo avvio servizio.

## 6) Aggiornamento dipendenze Python

Confrontare `requirements.txt` tra versione corrente e precedente:

```powershell
$old = "C:\Backup\PSTT_TOOL_2026-02-10\requirements.txt"
$new = "C:\App\PSTT_TOOL\requirements.txt"
Compare-Object (Get-Content $old) (Get-Content $new)
```

**Se ci sono modifiche**:
```powershell
cd C:\App\PSTT_TOOL
.\.venv\Scripts\python.exe -m pip install -r requirements.txt --upgrade
```

**Nota**: Release v1.2.0 NON introduce nuove dipendenze. Skip questo step se `requirements.txt` invariato.

## 7) Restart del Servizio

**Script di gestione** (consigliato):
```powershell
.\tools\manage_service.ps1 start
```

**PowerShell nativo**:
```powershell
Start-Service -Name PSTT_Tool
Get-Service -Name PSTT_Tool  # Verifica stato = Running
```

**SC.exe**:
```cmd
sc start PSTT_Tool
sc query PSTT_Tool
```

### Verifica avvio corretto
```powershell
# Log servizio (ultimi 50 righe)
Get-Content logs\service_stdout.log -Tail 50

# Health check API (attendere ~10 secondi dopo start)
Start-Sleep -Seconds 10
Invoke-RestMethod -Uri 'http://localhost:8000/health'
```

**Output atteso**:
```json
{
  "status": "healthy",
  "version": "1.2.0",
  "database_connections": "OK",
  "scheduler": "running"
}
```

## 8) Test funzionalità principali

### 8.1 Test Parametri Lista

1. **Accedere** a `http://localhost:8000`
2. **Selezionare** query `CDG-INF-004--Estrai tracciatura spedizione`
3. **Verificare** parametro `BARCODE_LIST` mostra **textarea** (5 righe)
4. **Inserire** valori test:
   ```
   123
   456
   789
   ```
5. **Verificare** contatore mostra `3 / 1000`
6. **Eseguire query** e verificare risultati corretti

### 8.2 Test Multi-Statement

1. **Selezionare** query `CDG-AL-002--Estrati Tracciatura - tracciato AEG`
2. **Verificare** query con preamble `ALTER SESSION SET...` esegue senza errori
3. **Controllare log** per conferma esecuzione multi-statement:
   ```powershell
   Select-String -Path logs\app.log -Pattern "STATEMENT_EXECUTE" | Select-Object -Last 10
   ```

### 8.3 Test Robustezza Scheduler

1. **Accedere** a `http://localhost:8000/settings`
2. **Verificare** sezione "Robustezza Scheduler" visibile con input:
   - `scheduler_coalesce_enabled` (dropdown true/false)
   - `scheduler_misfire_grace_time_sec` (input numerico)
3. **Salvare** e verificare ricaricamento scheduler via log:
   ```powershell
   Select-String -Path logs\app.log -Pattern "scheduler" | Select-Object -Last 20
   ```

## 9) Rollback (se necessario)

In caso di problemi:

```powershell
# Stop servizio
Stop-Service -Name PSTT_Tool -Force

# Ripristina backup
$src = "C:\Backup\PSTT_TOOL_2026-02-10"
$dst = "C:\App\PSTT_TOOL"
robocopy $src $dst /MIR /R:2 /W:2 /XD .venv logs exports

# Restart servizio
Start-Service -Name PSTT_Tool
```

## 10) Post-deployment

- ✅ Verificare log applicazione per errori: `logs\app.log`, `logs\service_stdout.log`
- ✅ Monitorare schedulazioni esistenti: `http://localhost:8000/scheduler`
- ✅ Testare esecuzione manuale query con parametri lista
- ✅ Verificare daily report email (se configurato)
- ✅ Controllare metriche scheduler: `http://localhost:8000/api/scheduler/metrics`

## Troubleshooting

### Problema: Parametro lista non viene trasformato

**Sintomo**: Query con `IN (&BARCODE)` fallisce

**Soluzione**: Rinominare parametro con pattern riconosciuto: `BARCODE_LIST`, `BARCODES`, `CODES`, `IDS`

Dettagli: [docs/TROUBLESHOOTING.md](../docs/TROUBLESHOOTING.md#-errori-parametri-lista-query)

### Problema: Servizio non parte dopo aggiornamento

**Diagnostica**:
```powershell
.\tools\diagnose_restart.ps1
Get-Content logs\service_stderr.log -Tail 50
```

**Cause comuni**:
- `connections.json` non valido → rivalidare JSON
- `.env` mancante o corrotto → ripristinare da backup
- Dipendenze Python non aggiornate → reinstallare requirements.txt

### Problema: Contatore parametri lista non funziona

**Causa**: Browser cache vecchia versione JavaScript

**Soluzione**:
```
Ctrl+F5 (hard refresh browser)
oppure
Clear cache browser: Ctrl+Shift+Del → Cache/Cookies → Cancella
```

## Contatti

Per supporto post-deployment:
- **Documentazione**: `docs/README.md`, `docs/TROUBLESHOOTING.md`
- **Log applicazione**: `logs/app.log`
- **Issue tracker**: (se configurato)

---

**Fine documento Update R20260210**
