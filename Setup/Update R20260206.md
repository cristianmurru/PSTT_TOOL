# Update R20260206

- Aggiornamento relativo alla release v1.1.9 con fix critici per restart servizio e report giornaliero.
- **Hot Restart**: riavvio applicazione senza privilegi amministratore tramite NSSM auto-restart (exit code 0).
- **Fix conteggio fallimenti**: report giornaliero ora include anche gli eventi `retry_scheduled` nel conteggio failure.
- **TROUBLESHOOTING**: aggiunto al visualizzatore markdown con link in tutte le pagine del menu Help.

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata (utente non operativo durante l'intervento).
- Percorso di installazione corrente della app (es.: `C:\PSTT_TOOL` o equivalente).
- Nome del Servizio Windows dell'applicazione (es.: `PSTT_TOOL`): verrà usato nei comandi sotto.
- Pacchetto sorgente aggiornato (cartella `app/`, `main.py`, `templates/`, `static/`, `docs/`, ecc.).
- **NSSM già installato e configurato** (se non già presente, seguire Setup iniziale in docs/README.md).

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (dalla root del progetto):
```powershell
# Eseguire nella cartella di installazione
.\tools\manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
# Verifica stato
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
Creare una copia di sicurezza dell'installazione:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-02-06"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento: se usi `robocopy`, escludi esplicitamente:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Elenco aree con modifiche in v1.1.9

#### Backend
- `app/api/system.py` — **MAJOR REFACTOR** del sistema restart:
  - Nuova funzione `_schedule_hot_restart()`: terminazione processo con `os._exit(0)` per trigger NSSM auto-restart
  - Refactoring `_restart_as_service()`: script PowerShell salvati su disco in `%TEMP%` come processi detached (flag 0x00000208)
  - Aggiornato `restart_app()`: nuovo parametro `hot_restart=True` (default), 3 strategie fallback
  - Nuovo endpoint `GET /api/system/service/restart-logs`: visualizzazione log restart da `%TEMP%`
- `app/services/daily_report_service.py` — Fix conteggio fallimenti (linea 92):
  - Cambiato da `status == "fail"` a `status in ("fail", "retry_scheduled")`
  - Ora tutti i fallimenti (inclusi retry schedulati) sono conteggiati correttamente nel report
- `app/main.py` — Aggiunta route `/docs/troubleshooting` per visualizzatore markdown (linee 217-244)

#### Frontend
- `app/templates/index.html` — Aggiunto link TROUBLESHOOTING in menu Help
- `app/templates/scheduler_dashboard.html` — Aggiunto link TROUBLESHOOTING in menu Help
- `app/templates/logs.html` — Aggiunto link TROUBLESHOOTING in menu Help
- `app/templates/settings.html` — Aggiunto link TROUBLESHOOTING in menu Help
- `app/templates/kafka_dashboard.html` — Aggiunto link TROUBLESHOOTING in menu Help
- `app/templates/markdown_viewer.html` — Aggiunto link TROUBLESHOOTING in menu Help

#### Test
- `tests/test_system_restart.py` — Aggiornamento completo suite restart (18 test):
  - ✅ **3 nuovi test**: `test_restart_endpoint_hot_restart_default`, `test_schedule_hot_restart_creates_timer`, `test_hot_restart_exits_with_code_zero`
  - ✅ **6 test aggiornati**: assertions cambiati da posizionali a keyword args (delay_sec=2), verifiche su script file invece di script inline, test integration per hot_restart
  - **RISULTATI**: 18 passed in 0.20s

#### Documentazione
- `docs/CHANGELOG.md` — Aggiunta versione v1.1.9 con dettagli completi (78 righe)
- `docs/README.md` — Aggiornata sezione "Riavvio servizio" con descrizione hot restart
- `docs/TROUBLESHOOTING.md` — Aggiornato dall'utente (fuori scope update, verificare manualmente se presente)

## 4) Configurazione NSSM per Hot Restart

**IMPORTANTE**: Per abilitare hot restart **senza privilegi amministratore**, configurare NSSM per auto-restart su exit code 0:

```powershell
# Da eseguire con privilegi amministrativi
cd C:\PSTT_TOOL

# Configurazione AppExit per auto-restart
.\tools\nssm.exe set PSTT_TOOL AppExit Default Restart

# Configurazione delay restart (5 secondi)
.\tools\nssm.exe set PSTT_TOOL AppRestartDelay 5000

# Verifica configurazione
.\tools\nssm.exe get PSTT_TOOL AppExit Default
.\tools\nssm.exe get PSTT_TOOL AppRestartDelay
```

Output atteso:
```
Default: Restart
5000
```

### Spiegazione tecnica
- **Hot Restart**: Quando l'applicazione chiama `os._exit(0)`, il servizio NSSM interpreta l'exit code 0 come "uscita pulita"
- **AppExit Default Restart**: NSSM è configurato per riavviare automaticamente il servizio su qualsiasi exit code (incluso 0)
- **AppRestartDelay 5000ms**: NSSM aspetta 5 secondi prima di riavviare (tempo per cleanup risorse)
- **Nessun privilegio admin richiesto**: Il processo termina da solo, NSSM si limita a rilanciarlo (non serve Stop-Service/Start-Service)
- **Reload completo**: All'avvio nuovo processo Python ricarica: connections.json, .env, schedulazioni, moduli Kafka/SMTP

### Downtime atteso
- **~7 secondi totali**: 2s delay applicazione + 5s AppRestartDelay NSSM
- La UI mostra overlay informativo con polling su `/health` (fase down → up)

## 5) Verifica installazione

### Check 1: File modificati presenti
```powershell
# Backend
Test-Path C:\PSTT_TOOL\app\api\system.py
Test-Path C:\PSTT_TOOL\app\services\daily_report_service.py
Test-Path C:\PSTT_TOOL\app\main.py

# Frontend
Test-Path C:\PSTT_TOOL\app\templates\index.html

# Documentazione
Test-Path C:\PSTT_TOOL\docs\CHANGELOG.md
Test-Path C:\PSTT_TOOL\docs\README.md
Test-Path C:\PSTT_TOOL\docs\TROUBLESHOOTING.md
```

### Check 2: Configurazione NSSM
```powershell
.\tools\nssm.exe get PSTT_TOOL AppExit Default
# Deve ritornare: Restart

.\tools\nssm.exe get PSTT_TOOL AppRestartDelay
# Deve ritornare: 5000
```

### Check 3: Avvio servizio
```powershell
.\tools\manage_service.ps1 start

# Verifica stato
Get-Service -Name PSTT_TOOL
# Status: Running

# Check health endpoint
Start-Sleep -Seconds 10
curl http://localhost:5003/health
```

Output atteso health:
```json
{"status": "healthy"}
```

### Check 4: Test restart da UI
1. Accedere a `http://localhost:5003`
2. Cliccare pulsante **"Riavvia App"** in navbar
3. Overlay dovrebbe mostrare:
   - **"Riavvio in corso..."** con spinner
   - **"Servizio non disponibile..."** (fase down)
   - **"Riavvio completato!"** con checkmark verde (fase up)
4. Verificare che servizio sia tornato operativo (~7 secondi)

### Check 5: Log restart
Accedere a `http://localhost:5003/api/system/service/restart-logs` per vedere log diagnostici salvati in `%TEMP%`:
- Timestamp restart
- Strategia utilizzata (hot_restart o fallback)
- Exit code e output PowerShell

### Check 6: Report giornaliero
1. Generare report da UI (se disponibili schedulazioni del giorno)
2. Verificare che failure count includa eventi con status `retry_scheduled`
3. Confrontare con vecchia versione: conteggio dovrebbe essere maggiore se ci sono retry schedulati

### Check 7: TROUBLESHOOTING in menu Help
1. Accedere a qualsiasi pagina (index, scheduler, logs, settings, kafka)
2. Cliccare dropdown menu **Help** (icona "?" in navbar)
3. Verificare presenza link **TROUBLESHOOTING** insieme a README e CHANGELOG
4. Cliccare link e verificare caricamento docs/TROUBLESHOOTING.md

## 6) Start del Servizio

Dopo verifiche preliminari, avviare il servizio:

```powershell
# Opzione 1: Script gestione
.\tools\manage_service.ps1 start

# Opzione 2: PowerShell nativo
Start-Service -Name PSTT_TOOL

# Opzione 3: SC.exe
sc start PSTT_TOOL
```

Verifica stato finale:
```powershell
Get-Service -Name PSTT_TOOL | Format-List

# Check log startup
Get-Content -Path "C:\PSTT_TOOL\logs\app.log" -Tail 50
```

## 7) Troubleshooting

### Problema: Hot restart non funziona (servizio non riparte)
**Sintomo**: Cliccando "Riavvia App" il servizio si ferma ma non riparte automaticamente.

**Causa**: Configurazione NSSM non corretta (AppExit Default mancante o settato a "Exit").

**Soluzione**:
```powershell
# Verificare configurazione corrente
.\tools\nssm.exe get PSTT_TOOL AppExit Default

# Se ritorna "Exit" o altro valore, riconfigurare:
.\tools\nssm.exe set PSTT_TOOL AppExit Default Restart

# Riavviare servizio manualmente
.\tools\manage_service.ps1 restart
```

### Problema: Restart lento (> 10 secondi)
**Sintomo**: L'overlay UI mostra fase down prolungata prima di tornare up.

**Causa**: AppRestartDelay troppo alto o carico server elevato.

**Soluzione**:
```powershell
# Verificare delay corrente
.\tools\nssm.exe get PSTT_TOOL AppRestartDelay

# Se > 5000ms, ridurre (min consigliato: 3000ms)
.\tools\nssm.exe set PSTT_TOOL AppRestartDelay 3000

# Test restart da UI
```

### Problema: Report giornaliero mostra ancora conteggi sbagliati
**Sintomo**: Failure count non include retry_scheduled anche dopo update.

**Causa**: Cache schedulazioni vecchia o report generato su dati pre-update.

**Soluzione**:
```powershell
# 1. Restart servizio (ricarica codice)
.\tools\manage_service.ps1 restart

# 2. Rigenerare report dalla UI
# 3. Verificare log app per conferma esecuzione nuovo codice
Get-Content C:\PSTT_TOOL\logs\app.log -Tail 100 | Select-String "report"
```

### Problema: TROUBLESHOOTING link non appare in menu Help
**Sintomo**: Menu Help mostra solo README e CHANGELOG, manca TROUBLESHOOTING.

**Causa**: Template non aggiornato correttamente o cache browser.

**Soluzione**:
```powershell
# 1. Verificare file template aggiornati
Select-String -Path C:\PSTT_TOOL\app\templates\*.html -Pattern "TROUBLESHOOTING"

# 2. Hard refresh browser (Ctrl+Shift+R)
# 3. Verificare versione in CHANGELOG (deve essere v1.1.9)
Get-Content C:\PSTT_TOOL\docs\CHANGELOG.md -Head 10
```

### Problema: Errore "nssm.exe not found" durante restart
**Sintomo**: Log restart mostrano errore di nssm.exe non trovato.

**Causa**: File nssm.exe mancante in cartella tools/ o root.

**Soluzione**:
```powershell
# Verificare presenza nssm.exe
Test-Path C:\PSTT_TOOL\tools\nssm.exe
Test-Path C:\PSTT_TOOL\nssm.exe

# Se mancante, copiare dal pacchetto sorgente
Copy-Item "C:\Pacchetto\PSTT_TOOL\tools\nssm.exe" "C:\PSTT_TOOL\tools\" -Force
Copy-Item "C:\Pacchetto\PSTT_TOOL\nssm.exe" "C:\PSTT_TOOL\" -Force

# Restart servizio
.\tools\manage_service.ps1 restart
```

## 8) Rollback (se necessario)

In caso di problemi critici, ripristinare versione precedente:

```powershell
# Stop servizio
Stop-Service -Name PSTT_TOOL -Force

# Ripristino da backup
$backup = "C:\Backup\PSTT_TOOL_2026-02-06"
$target = "C:\PSTT_TOOL"

# ATTENZIONE: Questo sovrascrive tutto tranne connections.json e .env
robocopy $backup $target /MIR /R:2 /W:2 /XF connections.json .env

# Restart servizio
Start-Service -Name PSTT_TOOL

# Verifica versione (deve essere precedente a v1.1.9)
Get-Content C:\PSTT_TOOL\docs\CHANGELOG.md -Head 10
```

## Note finali

- **Downtime stimato**: ~5-10 minuti (stop, copy file, configurazione NSSM, start, test)
- **Test consigliato**: Eseguire restart da UI e verificare che downtime sia ~7 secondi
- **Monitoraggio post-update**: Verificare log app.log per 24h per eventuali errori
- **Report giornaliero**: Verificare conteggi failure il giorno successivo all'update
- **Documentazione**: I link TROUBLESHOOTING sono ora disponibili in tutte le pagine del menu Help

## Changelog v1.1.9

Per dettagli completi delle modifiche, vedere [CHANGELOG.md](../docs/CHANGELOG.md) versione 1.1.9 (2026-02-06).

Modifiche principali:
- ✅ Hot restart senza privilegi amministratore (NSSM AppExit auto-restart)
- ✅ Fix conteggio fallimenti report giornaliero (retry_scheduled inclusi)
- ✅ TROUBLESHOOTING aggiunto al visualizzatore markdown
- ✅ Script PowerShell detached con log su disco in %TEMP%
- ✅ Nuovo endpoint /api/system/service/restart-logs per diagnostica
- ✅ Suite test aggiornata: 206 passed, 18 test restart (3 nuovi, 6 aggiornati)

---
**Data update**: 2026-02-06  
**Versione target**: v1.1.9  
**Branch**: feature/R20260206 → master (dopo PR approval)
