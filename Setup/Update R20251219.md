# Update R20251219

- Aggiornamento relativo ai commit "R20251218: UI status bar, safer preview LIMIT, scheduler timeout 900s".
- Scheduler Email: aggiunti campi configurabili da UI e da `connections.json` per l'invio via email dei file generati:
  - `email_to` (Destinatari A, separatore `|`)
  - `email_cc` (Destinatari CC, separatore `|`)
  - `email_subject` (Oggetto)
  - `email_body` (Corpo plain text). Se non valorizzato, viene applicato il seguente default:

    Buongiorno,
    in allegato estrazione relativa l'oggetto, generata da procedura automatica.
    Saluti,
    Report_PSTT

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata (utente non operativo durante l'intervento).
- Percorso di installazione corrente della app (es.: `C:\PSTT_TOOL` o equivalente).
- Nome del Servizio Windows dell'applicazione (es.: `PSTT_TOOL`): verrà usato nei comandi sotto.
- Pacchetto sorgente aggiornato (cartella `app/`, `main.py`, `templates/`, `static/`, `services/`, `core/`, `Query/`, `CHANGELOG.md`, ecc.).

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (se presente nella root):
```powershell
# Eseguire nella cartella di installazione
./manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
# Verifica stato
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
Creare una copia di sicurezza dell'installazione:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2025-12-18"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento: se usi `robocopy`, escludi esplicitamente:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Elenco aree con modifiche in R20251218
- Frontend: `app/templates/index.html`, `app/static/js/main.js` (barra di stato spostata, tempo ms/s, padding, deduplica label).
- Backend: `app/services/query_service.py` (anteprima LIMIT sicura: rimozione `;` finale, incapsulamento subselect per PostgreSQL/MySQL).
- Config: `app/core/config.py` (timeout scheduler portato a 600s).
- Query: aggiornata `Query/TT2_STAMPA-PCL-001--RistampeLDV post rerouting.sql`.
- Documentazione: `CHANGELOG.md`.

#### Dettaglio file da sovrascrivere (estensione 2025-12-19)
- `app/models/scheduling.py` — aggiunta campi email (`email_to`, `email_cc`, `email_subject`, `email_body`) con mantenimento di `email_recipients` per compatibilità.
- `app/core/config.py` — normalizzazione dei nuovi campi da `connections.json` con fallback legacy.
- `app/services/scheduler_service.py` — invio email con To/CC/Subject/Body; storico mantenuto integralmente e filtro applicato lato API.
- `app/api/scheduler.py` — filtro “ultimi 30 giorni” applicato nella risposta API.
- `app/frontend/scheduler_dashboard.html` — UI form Aggiunta/Modifica aggiornata con i nuovi campi email.

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Applicare invece le seguenti verifiche/modifiche:

### 4.1 `connections.json`
- Garantire che la struttura sia **JSON valido** (nessuna virgola finale, chiavi/valori coerenti).
- Se presente la connessione `C02-TT2_STAMPA` (o equivalente), allinearne la struttura ai campi attesi dalla versione corrente (driver, host, database, user, `previewLimit`, ecc.).
- Esempio di controllo rapido (PowerShell):
```powershell
# Valida il JSON
$path = "C:\PSTT_TOOL\connections.json"
Get-Content $path -Raw | ConvertFrom-Json | Out-Null; Write-Host "connections.json valido"
```

### 4.2 `.env`
- Verificare le credenziali e gli endpoint (`DB_*`, `ORACLE_*`, `POSTGRES_*`, `SQLSERVER_*`, ecc.).
- Non sono stati introdotti nuovi parametri obbligatori in R20251218; lasciare invariati quelli esistenti.
- Se desideri forzare un timeout differente da quello di default (600s) lato scheduler, farlo via configurazione applicativa se previsto: di default il valore è ora 900s.
 - Per l'invio email assicurarsi che siano configurati i parametri SMTP:
   - `smtp_host`, `smtp_port`, `smtp_user`, `smtp_password`, `smtp_from`.
 

## 5) Aggiornamento dipendenze (se necessario)
- Confrontare `requirements.txt` tra versione corrente e precedente.
- Se sono cambiati i pacchetti, aggiornare l'ambiente Python:
```powershell
# Esempio: ambiente virtuale
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

> Nota: se il server non ha accesso internet, preparare in anticipo i pacchetti wheel offline e installarli localmente.

## 6) Avvio del Servizio
- Script di gestione:
```powershell
./manage_service.ps1 start
```

- PowerShell nativo:
```powershell
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc start PSTT_TOOL
sc query PSTT_TOOL
```

## 7) Verifiche post-deploy
- UI:
  - La barra di stato è sotto la barra superiore e allineata ai margini.
  - Il tempo di esecuzione mostra `ms` e la conversione in secondi `(s)`.
  - Nessuna duplicazione del nome query; cambiando connessione, la barra di stato e i risultati si puliscono.
- Anteprima LIMIT:
  - Su PostgreSQL/MySQL la preview non inserisce `LIMIT` dentro stringhe letterali (query incapsulata in subselect).
  - Le query con `;` finale funzionano (il terminatore viene rimosso prima dell’applicazione del limite).
- Scheduler:
  - Le esecuzioni non vanno in timeout entro 10 minuti per le query più pesanti.
  - Verificare i log dell’applicazione/servizio per eventuali errori.

## 8) Rollback
In caso di problemi:
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2025-12-18" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- Evitare la sovrascrittura di `connections.json` e `.env`: mantenerli allineati e validi secondo le esigenze dell’ambiente.
- Documentare eventuali personalizzazioni locali (connessioni, permessi, cartelle di export) prima dell’aggiornamento.
- Archiviare il pacchetto sorgente e il backup per riferimento futuro.
