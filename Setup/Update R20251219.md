# Update R20251219

Questo aggiornamento integra quanto rilasciato ieri (R20251218) e introduce novità per lo scheduler email e la visibilità dello storico.

## Novità principali
- Scheduler Email: dalla UI è possibile configurare:
  - Destinatari A (campo `email_to` | separatore `|`)
  - Destinatari CC (campo `email_cc` | separatore `|`)
  - Oggetto (campo `email_subject`)
  - Corpo mail (campo `email_body`), precompilato con lo standard:
    
    ````
    Buongiorno,
    in allegato estrazione relativa l'oggetto, generata da procedura automatica.
    Saluti,
    Report_PSTT
    ````

- Storico schedulazioni: non viene più troncato all’avvio del servizio; l’API `/api/scheduler/history` applica il filtro degli ultimi 30 giorni in risposta, mantenendo su file l’intero storico.

## Impatto su configurazioni
- `connections.json` (sezione `scheduling`): i nuovi campi sono opzionali. Se presente `email_to` verrà usato al posto del legacy `email_recipients`.

  Esempio:
  ```json
  {
    "query": "TT2_STAMPA-PCL-001--RistampeLDV post rerouting.sql",
    "connection": "A04-TT2_STAMPA",
    "scheduling_mode": "classic",
    "days_of_week": [1,2,3,4,5],
    "hour": 8,
    "minute": 15,
    "sharing_mode": "email",
    "output_filename_template": "{query_name}_{date}.xlsx",
    "output_dir": "C:\\App\\PSTT_TOOL\\Exports",
    "email_to": "dest1@x.com|dest2@y.com",
    "email_cc": "cc1@x.com|cc2@y.com",
    "email_subject": "Report giornaliero TT2_STAMPA",
    "email_body": "Buongiorno,\nin allegato estrazione relativa l'oggetto, generata da procedura automatica.\nSaluti,\nReport_PSTT"
  }
  ```

- `.env` (SMTP): verificare i parametri SMTP per l’invio email.
  - `smtp_host`, `smtp_port`, `smtp_user`, `smtp_password`, `smtp_from`

## Sequenza Operativa (aggiornata)

1) Stop Servizio
```powershell
Stop-Service -Name PSTT_TOOL -Force
# oppure
./manage_service.ps1 stop
```

2) Backup installazione
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2025-12-19"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

3) Sovrascrittura file (escludendo `connections.json` e `.env`)
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

4) Aggiornare `connections.json` e `.env`
- `connections.json`: aggiungere i campi email sopra se si usa condivisione `email`. Validare JSON:
```powershell
Get-Content C:\PSTT_TOOL\connections.json -Raw | ConvertFrom-Json | Out-Null
```
- `.env`: controllare SMTP; per nuove connessioni DB (es. `A04-TT2_STAMPA`) referenziare variabili già esistenti quando condividono le stesse credenziali (es. riuso di `DB_USER_A04-TT2_UFFICIO` / `DB_PASS_A04-TT2_UFFICIO`).

5) Dipendenze (se variate)
```powershell
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

6) Avvio Servizio
```powershell
Start-Service -Name PSTT_TOOL
# oppure
./manage_service.ps1 start
```

7) Verifiche
- UI Scheduler: form “Aggiungi/Modifica” mostra i campi Email e il corpo standard.
- Invio Email: con `sharing_mode = email`, ricezione allegato con oggetto personalizzato.
- Storico: la sezione “Storico Schedulazioni (ultimi 30 giorni)” elenca le esecuzioni recenti, anche dopo riavvio.

8) Rollback
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2025-12-19" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- Non sovrascrivere `connections.json` e `.env` durante l’allineamento: aggiornarli solo con le modifiche necessarie.
- Documentare eventuali personalizzazioni locali.
