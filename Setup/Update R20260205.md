# Update R20260205

- Aggiornamento relativo alla release v1.1.8 con funzionalità di compressione export e riorganizzazione script servizio.
- **Compressione export gzip**: nuovo flag "Comprimi .gz" nelle schedulazioni per salvare file Excel compressi (`.xls.gz`) con riduzione spazio disco ~10-30%.
- **Riorganizzazione script**: spostamento di `install_service.ps1`, `manage_service.ps1` e `nssm.exe` nella cartella `tools/`.
- **Cleanup documentazione**: rimosso flag obsoleto "Includi timestamp" (sostituito da token `{timestamp}`), eliminata cartella `docs/Obsoleti/`.

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata (utente non operativo durante l'intervento).
- Percorso di installazione corrente della app (es.: `C:\PSTT_TOOL` o equivalente).
- Nome del Servizio Windows dell'applicazione (es.: `PSTT_TOOL`): verrà usato nei comandi sotto.
- Pacchetto sorgente aggiornato (cartella `app/`, `main.py`, `templates/`, `static/`, `services/`, `core/`, `Query/`, `tools/`, `docs/`, `CHANGELOG.md`, ecc.).

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (dalla root del progetto):
```powershell
# Eseguire nella cartella di installazione
.\tools\manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
# Verifica stato
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
Creare una copia di sicurezza dell'installazione:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-02-05"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento: se usi `robocopy`, escludi esplicitamente:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Elenco aree con modifiche in v1.1.8

#### Backend
- `app/models/scheduling.py` — aggiunto campo `output_compress_gz`, rimosso `output_include_timestamp`
- `app/services/scheduler_service.py` — implementata logica compressione gzip post-export con fallback
- `app/core/config.py` — normalizzazione scheduling aggiornata per gestire `output_compress_gz`
- `app/api/settings.py` — nessuna modifica funzionale

#### Frontend
- `app/templates/scheduler_dashboard.html` — UI aggiornata con checkbox "Comprimi .gz" in form ADD/EDIT, rimosso checkbox "Includi timestamp"
- `app/templates/settings.html` — nessuna modifica funzionale

#### Test
- `tests/test_compress_export.py` — nuovo test per verifica compressione/decompressione
- `tests/unit/test_scheduling_item.py` — aggiornato test per usare token `{timestamp}` invece di flag
- `tests/test_system_restart.py` — corretto path per cercare `install_service.ps1` in `tools/`

#### Tools e Scripts
- **IMPORTANTE**: `install_service.ps1`, `manage_service.ps1` e `nssm.exe` spostati dalla root alla cartella `tools/`
- `tools/diagnose_restart.ps1` — aggiornato path per cercare `manage_service.ps1` in `tools/`

#### Documentazione
- `docs/CHANGELOG.md` — aggiunta versione v1.1.8
- `docs/README.md` — aggiornati path per script servizio (ora in `tools/`)
- `docs/TESTING.md` — aggiornato e modernizzato con funzionalità v1.1.7
- `docs/TROUBLESHOOTING.md` — aggiornato e modernizzato con scenari Kafka e scheduler
- `docs/KAFKA_SETUP.md` — aggiornati path per `manage_service.ps1`
- `docs/KAFKA_RUNBOOK.md` — aggiornati path per `manage_service.ps1`
- `docs/Obsoleti/` — **cartella eliminata** (21 file obsoleti), 3 file Kafka preservati e spostati in `docs/`

#### Query
- Nessuna modifica alle query SQL in questo aggiornamento

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Applicare invece le seguenti verifiche/modifiche:

### 4.1 `connections.json`
- Garantire che la struttura sia **JSON valido** (nessuna virgola finale, chiavi/valori coerenti).
- Le schedulazioni esistenti continueranno a funzionare senza modifiche (default `output_compress_gz=false`).
- **Opzionale**: per abilitare la compressione su schedulazioni esistenti, aggiungere il campo `output_compress_gz: true` nelle schedulazioni desiderate.
- Esempio di controllo rapido (PowerShell):
```powershell
# Valida il JSON
$path = "C:\PSTT_TOOL\connections.json"
Get-Content $path -Raw | ConvertFrom-Json | Out-Null; Write-Host "connections.json valido"
```

**Esempio schedulazione con compressione abilitata**:
```json
{
  "name": "Report Giornaliero",
  "connection": "C01-ORACLE_PROD",
  "query": "RPT-001--Report_Giornaliero.sql",
  "scheduling_mode": "classic",
  "hour": 8,
  "minute": 0,
  "sharing_mode": "filesystem",
  "output_path": "exports/",
  "output_filename_template": "report_{date}.xlsx",
  "output_compress_gz": true
}
```

### 4.2 `.env`
- Verificare le credenziali e gli endpoint (`DB_*`, `ORACLE_*`, `POSTGRES_*`, `SQLSERVER_*`, ecc.).
- Non sono stati introdotti nuovi parametri obbligatori in v1.1.8; lasciare invariati quelli esistenti.
- Per l'invio email assicurarsi che siano configurati i parametri SMTP:
  - `smtp_host`, `smtp_port`, `smtp_user`, `smtp_password`, `smtp_from`.

## 5) Aggiornamento dipendenze (se necessario)
- Confrontare `requirements.txt` tra versione corrente e precedente.
- Se sono cambiati i pacchetti, aggiornare l'ambiente Python:
```powershell
# Esempio: ambiente virtuale
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

> Nota: se il server non ha accesso internet, preparare in anticipo i pacchetti wheel offline e installarli localmente.

**Per questa release**: nessuna modifica ai `requirements.txt`.

## 6) Avvio del Servizio
- Script di gestione (dalla root del progetto):
```powershell
.\tools\manage_service.ps1 start
```

- PowerShell nativo:
```powershell
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc start PSTT_TOOL
sc query PSTT_TOOL
```

## 7) Verifiche post-deploy

### 7.1 Compressione export
- Creare una nuova schedulazione o modificarne una esistente.
- Abilitare il flag "Comprimi .gz" nella UI (o impostare `output_compress_gz: true` in `connections.json`).
- Eseguire manualmente o attendere l'esecuzione schedulata.
- Verificare in `exports/` la presenza del file `.xls.gz`.
- Doppio click sul file: Windows dovrebbe aprire direttamente Excel con il contenuto.
- Controllare i log per i messaggi `COMPRESS_START`, `COMPRESS_OK` o `COMPRESS_FAIL`.

### 7.2 Script servizio
- Verificare che gli script nella cartella `tools/` funzionino correttamente:
```powershell
.\tools\manage_service.ps1 -Action status
```
- Il comando dovrebbe restituire lo stato del servizio senza errori.

### 7.3 Test suite
- **Opzionale**: se l'ambiente di collaudo/produzione ha l'ambiente di sviluppo, eseguire i test:
```powershell
.venv\Scripts\python.exe -m pytest -v
```
- Atteso: 201 passed, 0 failed.

### 7.4 Funzionalità esistenti
- Verificare che le schedulazioni esistenti continuino a funzionare normalmente.
- Verificare che i file export senza compressione (`.xlsx`) vengano ancora generati correttamente.
- Verificare l'invio email se configurato.
- Verificare export Kafka se configurato.

## 8) Rollback
In caso di problemi:
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2026-02-05" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

**Nota**: il rollback ripristinerà gli script nella root (`install_service.ps1`, `manage_service.ps1`, `nssm.exe`) invece che in `tools/`. Gli script continueranno a funzionare da entrambe le posizioni.

## 9) Cleanup post-deploy (opzionale)
Dopo aver verificato che tutto funzioni correttamente:

- Se il backup occupa troppo spazio e sono trascorsi alcuni giorni senza problemi, considerare di eliminarlo o comprimerlo:
```powershell
Compress-Archive -Path "C:\Backup\PSTT_TOOL_2026-02-05" -DestinationPath "C:\Backup\PSTT_TOOL_2026-02-05.zip"
Remove-Item "C:\Backup\PSTT_TOOL_2026-02-05" -Recurse -Force
```

## Note operative
- Evitare la sovrascrittura di `connections.json` e `.env`: mantenerli allineati e validi secondo le esigenze dell'ambiente.
- La compressione è **opt-in**: le schedulazioni esistenti continueranno a generare file `.xlsx` non compressi a meno che non venga esplicitamente abilitato il flag.
- I file `.xls.gz` occupano ~10-30% meno spazio e si aprono direttamente in Windows Explorer/Excel senza passaggi aggiuntivi.
- Gli script nella cartella `tools/` cercano automaticamente `nssm.exe` nelle sottocartelle, quindi funzioneranno anche se `nssm.exe` è altrove nel progetto.
- Documentare eventuali personalizzazioni locali (connessioni, permessi, cartelle di export) prima dell'aggiornamento.
- Archiviare il pacchetto sorgente e il backup per riferimento futuro.

## Benefici della release v1.1.8
- ✅ Riduzione spazio disco per export (10-30% con compressione gzip)
- ✅ Apertura trasparente file compressi in Windows
- ✅ Organizzazione migliorata del progetto (script servizio centralizzati in `tools/`)
- ✅ Documentazione aggiornata e modernizzata
- ✅ Codice pulito (rimosso flag obsoleto "Includi timestamp")
- ✅ Compatibilità retroattiva completa (nessun breaking change)
