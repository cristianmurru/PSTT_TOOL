# Update R20260115

- Aggiornamento relativo al commit "fix: service restart with native Windows commands (no NSSM dependency)"
- **CRITICAL FIX**: Risolto problema restart da UI in ambienti dove NSSM non √® nel PATH di sistema
- Semplificata logica restart eliminando dipendenza da NSSM: usa solo comandi Windows nativi
- Aggiornata configurazione NSSM per prevenire loop infiniti di restart

## Prerequisiti
- Accesso al server con privilegi amministrativi
- Finestra di manutenzione concordata (utente non operativo durante l'intervento)
- Percorso di installazione corrente dell'app (es.: `C:\PSTT_TOOL`)
- Nome del Servizio Windows dell'applicazione: `PSTT_Tool`
- Pacchetto sorgente aggiornato

## 1) Stop del Servizio

Scegli una delle opzioni:

- Script di gestione (se presente nella root):
```powershell
# Eseguire nella cartella di installazione
.\manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_Tool -Force
# Verifica stato
Get-Service -Name PSTT_Tool
```

- SC.exe:
```cmd
sc stop PSTT_Tool
sc query PSTT_Tool
```

## 2) Backup installazione corrente

Creare una copia di sicurezza dell'installazione:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-01-15"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)

- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`
  - `exports/scheduler_history.json`
  - `exports/scheduler_metrics.json`

Suggerimento: se usi `robocopy`, escludi esplicitamente:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv exports logs /XF connections.json .env
```

### File modificati in R20260115

#### Backend - Sistema Restart
- **`app/api/system.py`** 
  - ‚úÖ Riscritta funzione `_restart_as_service()` per usare solo `Stop-Service`/`Start-Service` nativi Windows
  - ‚úÖ Rimossa dipendenza da NSSM per restart (ora funziona anche se NSSM non √® nel PATH)
  - ‚úÖ Aggiunto retry logic con 5 tentativi e delay di 2 secondi
  - ‚úÖ Esecuzione in background con `CREATE_NO_WINDOW` per evitare finestre popup
  - ‚úÖ Eliminata chiamata `_exit_process()` in modalit√† service (previene loop infiniti)
  - ‚úÖ Migliore logging per troubleshooting

#### Configurazione Servizio
- **`install_service.ps1`**
  - ‚úÖ Cambiato `AppExit Default Restart` ‚Üí `AppExit Default Exit`
  - ‚úÖ Il servizio NON si riavvia pi√π automaticamente su exit code 0 (terminazione normale)
  - ‚úÖ Restart automatico solo su crash reali (exit code diverso da 0)

#### Tools
- **`tools/diagnose_restart.ps1`** (NUOVO)
  - ‚úÖ Script diagnostico completo per troubleshooting restart failures
  - ‚úÖ Verifica: servizio, NSSM nel PATH, manage_service.ps1, configurazione NSSM, .env, porte in ascolto
  - ‚úÖ Identifica problemi critici e warning con raccomandazioni automatiche

#### Test
- **`tests/test_system_restart.py`** (NUOVO - 14 test)
  - ‚úÖ Test detection service vs terminal mode
  - ‚úÖ Verifica anti-loop: `_exit_process()` non chiamato in service mode (CRITICAL)
  - ‚úÖ Test end-to-end per entrambi i flussi
  - ‚úÖ Test regressione per verificare risoluzione bug loop restart
  - ‚úÖ Verifica configurazione NSSM corretta

#### Documentazione
- **`README.md`** - Aggiornata sezione Riavvio servizio (non richiede pi√π NSSM nel PATH)
- **`CHANGELOG.md`** - Documentate tutte le modifiche versione 1.0.3

## 4) Eccezioni: aggiornare configurazione NSSM

### 4.1 Configurazione NSSM (IMPORTANTE)

‚ö†Ô∏è **Azione richiesta per prevenire loop infiniti di restart**:

Eseguire in PowerShell amministrativo:

```powershell
# Modifica configurazione NSSM per evitare restart su exit 0
nssm set PSTT_Tool AppExit Default Exit

# Verifica configurazione applicata
nssm get PSTT_Tool AppExit
# Output atteso: Default Exit

# Restart servizio per applicare
nssm restart PSTT_Tool
```

**Spiegazione**: Con `AppExit Default Exit`, il servizio si riavvia automaticamente solo su crash reali (exit code != 0). 
L'exit code 0 (terminazione normale) NON causa pi√π restart automatico, prevenendo loop infiniti.

### 4.2 `.env`

Nessuna modifica richiesta per `.env` in questa release.

### 4.3 `connections.json`

Nessuna modifica richiesta per `connections.json` in questa release.

## 5) Aggiornamento dipendenze

Nessuna nuova dipendenza in questa release. Confermare che `requirements.txt` sia allineato:

```powershell
cd C:\PSTT_TOOL
.\.venv\Scripts\activate
pip install -r requirements.txt --upgrade
```

## 6) Start del Servizio

```powershell
# Opzione 1: Script di gestione
.\manage_service.ps1 start

# Opzione 2: PowerShell nativo
Start-Service -Name PSTT_Tool

# Opzione 3: SC.exe
sc start PSTT_Tool
```

Verifica stato:
```powershell
Get-Service -Name PSTT_Tool
# Status dovrebbe essere: Running
```

## 7) Verifica funzionamento

### 7.1 Health Check
```powershell
# Verifica che l'app risponda
curl http://localhost:8000/health
# oppure
Invoke-WebRequest -Uri "http://localhost:8000/health" -UseBasicParsing
```

Output atteso: `{"status":"healthy"}`

### 7.2 Verifica Porta in ascolto
```powershell
# Verifica porta configurata in .env (default 8000)
$port = (Select-String -Path "C:\PSTT_TOOL\.env" -Pattern "^PORT=").Line -replace "PORT=", ""
Get-NetTCPConnection -LocalPort $port -State Listen -ErrorAction SilentlyContinue

# Dovrebbe mostrare il processo in ascolto
```

### 7.3 Test Restart da UI

1. Accedi alla dashboard: `http://localhost:8000` (o porta configurata)
2. Vai nella sezione Sistema
3. Clicca "Riavvia Applicazione"
4. Attendi l'overlay di monitoraggio (down ‚Üí up)
5. Verifica che la dashboard torni operativa entro 15-20 secondi

**Comportamento atteso**: Il servizio si ferma, attende 3 secondi, poi si riavvia con retry automatico fino a 5 tentativi.

### 7.4 Troubleshooting (se restart fallisce)

Esegui lo script diagnostico:
```powershell
cd C:\PSTT_TOOL\tools
.\diagnose_restart.ps1
```

Lo script identificher√† problemi come:
- Servizio non installato
- NSSM non nel PATH (ora non pi√π critico, ma utile saperlo)
- Configurazione NSSM errata
- Porte in conflitto
- Errori nei log recenti

## 8) Verifica Log

Controllare i log per confermare assenza di errori:

```powershell
# Log applicazione
Get-Content C:\PSTT_TOOL\logs\app.log -Tail 50

# Log errori
Get-Content C:\PSTT_TOOL\logs\error.log -Tail 20

# Log servizio NSSM
Get-Content C:\PSTT_TOOL\logs\service_stdout.log -Tail 30
```

**Pattern atteso nei log dopo restart da UI**:
```
INFO: Restarting service: PSTT_Tool
INFO: Service restart command sent for PSTT_Tool
INFO: üöÄ Avvio PSTT Tool...
INFO: ‚úÖ SchedulerService avviato con job da configurazione
INFO: üåê Server in ascolto su http://127.0.0.1:8000
```

**Pattern da NON vedere** (indica problema risolto):
```
# NON dovrebbero pi√π esserci loop come questi:
INFO: üöÄ Avvio PSTT Tool...
INFO: üõë Arresto PSTT Tool...
INFO: üöÄ Avvio PSTT Tool...  # <- loop infinito risolto
INFO: üõë Arresto PSTT Tool...
```

## 9) Test Suite (Opzionale - solo per ambienti di test)

Se desideri validare l'installazione con la suite test completa:

```powershell
cd C:\PSTT_TOOL
.\.venv\Scripts\activate
pytest tests/ -v
```

Output atteso: **85 test passati**

## 10) Rollback (se necessario)

In caso di problemi critici:

```powershell
# Stop servizio
Stop-Service -Name PSTT_Tool -Force

# Ripristina backup
robocopy "C:\Backup\PSTT_TOOL_2026-01-15" "C:\PSTT_TOOL" /MIR /R:2 /W:2

# Ripristina configurazione NSSM precedente (se modificata)
nssm set PSTT_Tool AppExit Default Restart

# Start servizio
Start-Service -Name PSTT_Tool
```

## Note Finali

- ‚úÖ Questa release risolve un problema critico di restart in ambienti dove NSSM non √® nel PATH
- ‚úÖ Il restart da UI ora funziona usando solo comandi Windows nativi
- ‚úÖ Eliminato rischio di loop infiniti di restart
- ‚úÖ Migliore diagnostica con script dedicato
- ‚úÖ Test coverage aumentata: 71 ‚Üí 85 test (+14 test specifici per restart)

Per problemi o domande: contattare il team di sviluppo PSTT Tool.
