# Update R20260108

Aggiornamento relativo ai lavori su `feature/R20260107` (Settings UI, Report giornaliero, navbar coerenza, ampliamento test).

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata.
- Percorso di installazione corrente dell'app (es.: `C:\PSTT_TOOL` o equivalente).
- Nome del Servizio Windows dell'applicazione (es.: `PSTT_TOOL`).
- Pacchetto sorgente aggiornato (cartella `app/`, `main.py`, `templates/`, `static/`, `services/`, `core/`, `frontend/`, `api/`, `CHANGELOG.md`, ecc.).

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script gestione (se presenti nella root):
```powershell
./manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-01-08"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento: con `robocopy` escludere esplicitamente:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Aree/moduli modificati
- Frontend:
  - `app/frontend/settings.html` — nuova pagina Impostazioni (icona gear corretta, titoli di sezione più grandi, spacing).
  - `app/frontend/logs.html` — aggiunto link a Impostazioni in navbar.
  - `app/frontend/scheduler_dashboard.html` — aggiunti link "Log" e "Impostazioni" in navbar.
- API:
  - `app/api/settings.py` — nuove rotte `GET/POST /api/settings/env` per leggere/scrivere chiavi consentite in `.env`.
- Service:
  - `app/services/daily_report_service.py` — HTML report con colonna "Partenza" e colonna "Errore" più ampia; subject default "Report schedulazioni PSTT"; STARTTLS per SMTP.
  - `app/services/scheduler_service.py` — storico include `start_date`.
- Main:
  - `app/main.py` — registrazione router Settings, route `/settings`.
- Test:
  - Aggiunte nuove verifiche UI/API; suite `pytest` verde con 71 test.

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Applicare le seguenti verifiche/modifiche:

### 4.1 `.env`
- Verificare/valorizzare i parametri SMTP:
  - `smtp_host`, `smtp_port` (es. 587), `smtp_user`, `smtp_password`, `smtp_from`.
- Configurazione Report giornaliero:
  - `DAILY_REPORT_ENABLED=true|false`
  - `DAILY_REPORT_CRON` (se vuoto, verrà usato `DAILY_REPORTS_HOUR`)
  - `DAILY_REPORTS_HOUR=6` (esempio)
  - `DAILY_REPORT_RECIPIENTS=a@x|b@y` (pipe come separatore)
  - `DAILY_REPORT_CC=` (opzionale)
  - `DAILY_REPORT_SUBJECT=Report schedulazioni PSTT`
  - `DAILY_REPORT_TAIL_LINES=50`

> Nota: Le modifiche effettuate via pagina `/settings` scrivono `.env`; per riflettersi nelle schedulazioni potrebbe essere necessario riavviare il servizio.

### 4.2 `connections.json`
- Nessuna modifica obbligatoria in questo aggiornamento.
- Verificare comunque che il file sia JSON valido.

## 5) Aggiornamento dipendenze (se necessario)
Confrontare `requirements.txt`. Se cambiate, installare:
```powershell
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

## 6) Avvio del Servizio
```powershell
./manage_service.ps1 start
# oppure
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
```

## 7) Verifiche post-deploy
- UI:
  - Navbar coerente su Home/Logs/Dashboard/Settings (link presenti).
  - Settings: gear visibile, titoli sezione evidenti, salvataggio chiavi `.env`.
- Report giornaliero:
  - Anteprima `GET /api/reports/daily?date=YYYY-MM-DD` restituisce HTML.
  - Invio manuale `POST /api/reports/daily/send?date=YYYY-MM-DD` (richiede SMTP configurato).
- Log Viewer: lista/lettura file `.log` e `.gz` funzionante.
- Test: eseguire `pytest` (atteso 71 passed).

## 8) Rollback
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2026-01-08" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- Evitare la sovrascrittura di `connections.json` e `.env`.
- Documentare eventuali personalizzazioni locali prima dell'aggiornamento.
- STARTTLS è la modalità SMTP supportata; eventuali modifiche SSL non sono richieste.
