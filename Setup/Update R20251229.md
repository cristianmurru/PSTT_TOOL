# Update R20251229

- Aggiornamento relativo a miglioramenti UI Scheduler, fix API delete mirata e token oggetto/corpo email.
- Scheduler: affinamento layout form Aggiungi/Modifica e allineamenti (bordi destri e sinistri, spaziature, focus), filtro Query per Connessione.
- API: `DELETE /api/scheduler/scheduling/{idx}` ora rimuove solo la schedulazione selezionata.
- Email: supporto ai token (stessi dei filename) anche in oggetto e corpo email.
- UI elenco schedulazioni: badge "Data fine validità" con evidenza in rosso se scaduta.

## Prerequisiti
- Accesso al server con privilegi amministrativi.
- Finestra di manutenzione concordata (utente non operativo durante l'intervento).
- Percorso di installazione corrente della app (es.: `C:\PSTT_TOOL` o equivalente).
- Nome del Servizio Windows dell'applicazione (es.: `PSTT_TOOL`): verrà usato nei comandi sotto.
- Pacchetto sorgente aggiornato (cartella `app/`, `main.py`, `templates/`, `static/`, `services/`, `core/`, `Query/`, `CHANGELOG.md`, ecc.).

## 1) Stop del Servizio
Scegli una delle opzioni:

- Script di gestione (se presente nella root):
```powershell
# Eseguire nella cartella di installazione
./manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_TOOL -Force
# Verifica stato
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc stop PSTT_TOOL
sc query PSTT_TOOL
```

## 2) Backup installazione corrente
Creare una copia di sicurezza dell'installazione:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2025-12-29"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)
- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione.
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`

Suggerimento: se usi `robocopy`, escludi esplicitamente:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv /XF connections.json .env
```

### Elenco aree con modifiche in R20251229
- Frontend: `app/frontend/scheduler_dashboard.html` (layout uniformato tra Aggiungi/Modifica, spaziature, allineamenti, filtro Query per Connessione, badge scadenza).
- Backend: `app/api/scheduler.py` (delete per indice, senza purge su altre schedulazioni della stessa query).
- Modello/Servizio: `app/models/scheduling.py`, `app/services/scheduler_service.py` (token rendering riutilizzabile; oggetto/corpo email con token).
- Documentazione: `CHANGELOG.md` aggiornato.

#### Dettaglio file da sovrascrivere (estensione 2025-12-29)
- `app/models/scheduling.py` — helper per token comuni e `render_string()` per riuso in oggetto/corpo email.
- `app/services/scheduler_service.py` — rimozione import interno, utilizzo `render_string()` su subject/body email, gestione file temporanei e metriche.
- `app/api/scheduler.py` — `DELETE` mirato per indice; normalizzazione cron (5 campi).
- `app/frontend/scheduler_dashboard.html` — griglia prima riga (Connessione/Query/Data fine), allineamenti bordi, spaziature, filtro Query.

## 4) Eccezioni: aggiornare `connections.json` e `.env`
Questi file **non vanno sovrascritti**. Applicare invece le seguenti verifiche/modifiche:

### 4.1 `connections.json`
- Nessuna modifica obbligatoria per R20251229.
- Verificare che le schedulazioni correnti riflettano il comportamento atteso del delete: se presenti duplicati (classic/cron) della stessa query, l'eliminazione avviene solo per l'elemento selezionato.
- Se si desidera utilizzare i token in `email_subject`/`email_body`, valorizzare i testi direttamente nelle schedulazioni (UI o JSON) secondo le necessità.

### 4.2 `.env`
- Nessuna nuova variabile obbligatoria in R20251229.
- Assicurarsi che i parametri SMTP siano configurati correttamente per l'invio email (se usato): `smtp_host`, `smtp_port`, `smtp_user`, `smtp_password`, `smtp_from`.

## 5) Aggiornamento dipendenze (se necessario)
- Confrontare `requirements.txt` tra versione corrente e precedente.
- Per questa release non sono previsti aggiornamenti obbligatori di dipendenze.
- Se servisse aggiornare l'ambiente Python:
```powershell
# Esempio: ambiente virtuale
C:\PSTT_TOOL\.venv\Scripts\pip.exe install -r C:\PSTT_TOOL\requirements.txt
```

> Nota: se il server non ha accesso internet, preparare in anticipo i pacchetti wheel offline e installarli localmente.

## 6) Avvio del Servizio
- Script di gestione:
```powershell
./manage_service.ps1 start
```

- PowerShell nativo:
```powershell
Start-Service -Name PSTT_TOOL
Get-Service -Name PSTT_TOOL
```

- SC.exe:
```cmd
sc start PSTT_TOOL
sc query PSTT_TOOL
```

## 7) Verifiche post-deploy
- UI Scheduler:
  - Moduli Aggiungi/Modifica con layout allineato; campi di destra (Output/Email) si estendono fino al bordo destro; "Data fine" allineata al bordo destro.
  - Filtro Query in base alla Connessione; selezioni preservate.
  - Badge scadenza rosso se data fine già trascorsa.
- Email:
  - Oggetto e corpo email supportano token (come i filename). Verificare sostituzione corretta su esecuzione schedulata.
- API:
  - Eliminazione di una schedulazione non impatta le altre schedulazioni della stessa query.
- Log/Servizio:
  - Assenza di errori al riavvio; esecuzioni pianificate caricate correttamente.

## 8) Rollback
In caso di problemi:
```powershell
Stop-Service -Name PSTT_TOOL -Force
robocopy "C:\Backup\PSTT_TOOL_2025-12-29" "C:\PSTT_TOOL" /MIR /R:2 /W:2
Start-Service -Name PSTT_TOOL
```

## Note operative
- Evitare la sovrascrittura di `connections.json` e `.env`: mantenerli allineati e validi secondo le esigenze dell’ambiente.
- Documentare eventuali personalizzazioni locali (connessioni, permessi, cartelle di export) prima dell’aggiornamento.
- Archiviare il pacchetto sorgente e il backup per riferimento futuro.
