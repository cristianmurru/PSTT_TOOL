# Update R20260117

- Aggiornamento relativo al commit "fix(system): multi-strategy restart with NSSM fallback for production reliability"
- **ENHANCEMENT**: Implementata strategia multi-fallback per restart servizio in ambienti enterprise
- Risolve problemi di restart in produzione dove comandi Windows nativi possono fallire per policy/permessi
- Nessuna modifica richiesta a connections.json o .env

## Prerequisiti
- Accesso al server con privilegi amministrativi
- Finestra di manutenzione concordata (utente non operativo durante l'intervento)
- Percorso di installazione corrente dell'app (es.: `C:\PSTT_TOOL`)
- Nome del Servizio Windows dell'applicazione: `PSTT_Tool`
- Pacchetto sorgente aggiornato
- **Raccomandato**: NSSM installato e disponibile nel PATH (per ambienti con policy restrittive)

## 1) Stop del Servizio

Scegli una delle opzioni:

- Script di gestione (se presente nella root):
```powershell
# Eseguire nella cartella di installazione
.\manage_service.ps1 stop
```

- PowerShell nativo:
```powershell
Stop-Service -Name PSTT_Tool -Force
# Verifica stato
Get-Service -Name PSTT_Tool
```

- SC.exe:
```cmd
sc stop PSTT_Tool
sc query PSTT_Tool
```

## 2) Backup installazione corrente

Creare una copia di sicurezza dell'installazione:
```powershell
$src = "C:\PSTT_TOOL"
$dst = "C:\Backup\PSTT_TOOL_2026-01-17"
New-Item -ItemType Directory -Path $dst -Force | Out-Null
robocopy $src $dst /MIR /R:2 /W:2
```

## 3) Sovrascrittura file aggiornati (esclusioni)

- Copiare i file aggiornati dal pacchetto sorgente nella cartella di installazione
- **Non sovrascrivere**:
  - `connections.json`
  - `.env`
  - `exports/scheduler_history.json`
  - `exports/scheduler_metrics.json`

Suggerimento: se usi `robocopy`, escludi esplicitamente:
```powershell
robocopy "C:\Pacchetto\PSTT_TOOL" "C:\PSTT_TOOL" /MIR /R:2 /W:2 /XD .venv exports logs /XF connections.json .env
```

### File modificati in R20260117

#### Backend - Sistema Restart (ENHANCEMENT)
- **`app/api/system.py`** 
  - ‚úÖ Aggiunta funzione `_check_nssm_available()` per verificare disponibilit√† NSSM
  - ‚úÖ Riscritta `_restart_as_service()` con strategia multi-fallback:
    - **Strategia 1** (preferita): Comandi Windows nativi (`Stop-Service`/`Start-Service`)
    - **Strategia 2** (fallback): `nssm restart` se comandi nativi falliscono
    - **Strategia 3** (ultimo resort): `nssm stop` + wait + `nssm start`
  - ‚úÖ Logging dettagliato per ogni strategia tentata (successo/fallimento)
  - ‚úÖ Migliore gestione errori con try-catch progressivi

#### Documentazione
- **`README.md`** - Aggiornata sezione Riavvio servizio con descrizione multi-strategia
- **`CHANGELOG.md`** - Documentate tutte le modifiche versione 1.0.4

## 4) Eccezioni: verificare configurazione NSSM (opzionale ma raccomandato)

### 4.1 Configurazione NSSM

‚ö†Ô∏è **Verifica configurazione per evitare loop di restart**:

```powershell
# Verifica configurazione NSSM
nssm get PSTT_Tool AppExit Default
# Output atteso: Exit

# Se restituisce "Restart", modificare:
nssm set PSTT_Tool AppExit Default Exit
```

**Nota**: Questa configurazione previene restart automatici su exit code 0 (terminazione normale).

### 4.2 `.env`

Nessuna modifica richiesta per `.env` in questa release.

### 4.3 `connections.json`

Nessuna modifica richiesta per `connections.json` in questa release.

## 5) Aggiornamento dipendenze

Nessuna nuova dipendenza in questa release. Confermare che `requirements.txt` sia allineato:

```powershell
cd C:\PSTT_TOOL
.\.venv\Scripts\activate
pip install -r requirements.txt --upgrade
```

## 6) Start del Servizio

```powershell
# Opzione 1: Script di gestione
.\manage_service.ps1 start

# Opzione 2: PowerShell nativo
Start-Service -Name PSTT_Tool

# Opzione 3: SC.exe
sc start PSTT_Tool
```

Verifica stato:
```powershell
Get-Service -Name PSTT_Tool
# Status dovrebbe essere: Running
```

## 7) Verifica funzionamento

### 7.1 Health Check
```powershell
# Verifica che l'app risponda
curl http://localhost:8000/health
# oppure
Invoke-WebRequest -Uri "http://localhost:8000/health" -UseBasicParsing
```

Output atteso: `{"status":"healthy"}`

### 7.2 Verifica Porta in ascolto
```powershell
# Verifica porta configurata in .env (default 8000)
$port = (Select-String -Path "C:\PSTT_TOOL\.env" -Pattern "^PORT=").Line -replace "PORT=", ""
Get-NetTCPConnection -LocalPort $port -State Listen -ErrorAction SilentlyContinue

# Dovrebbe mostrare il processo in ascolto
```

### 7.3 Test Restart da UI

1. Accedi alla dashboard: `http://localhost:8000` (o porta configurata)
2. Vai nella sezione **Impostazioni** (Settings)
3. Clicca **"Riavvia App"**
4. Attendi l'overlay di monitoraggio (down ‚Üí up)
5. Verifica che la dashboard torni operativa entro 15-20 secondi

**Comportamento atteso**: 
- Il servizio si ferma
- Attende 3 secondi
- Si riavvia automaticamente
- Se una strategia fallisce, prova automaticamente le alternative

### 7.4 Verifica Strategia Utilizzata nei Log

Controlla quale strategia √® stata usata con successo:

```powershell
# Log applicazione - cerca pattern "Strategy"
Get-Content C:\PSTT_TOOL\logs\app.log -Tail 50 | Select-String "Strategy|Restarting service"
```

Pattern attesi:
```
INFO: Restarting service: PSTT_Tool
INFO: Strategy 1: Trying Windows native Stop-Service/Start-Service
INFO: Service restart command sent (native Windows commands) for PSTT_Tool
```

Se Strategia 1 fallisce per permessi, vedrai:
```
WARNING: Strategy 1 failed: ...
INFO: Strategy 2: Trying NSSM restart command
INFO: Service restart via NSSM sent for PSTT_Tool
```

### 7.5 Troubleshooting (se restart fallisce)

Esegui lo script diagnostico:
```powershell
cd C:\PSTT_TOOL\tools
.\diagnose_restart.ps1
```

Lo script identificher√†:
- Servizio non installato
- NSSM non disponibile (ora opzionale, ma utile come fallback)
- Configurazione NSSM errata
- Porte in conflitto
- Errori nei log recenti
- **Policy aziendali** che bloccano comandi PowerShell

## 8) Verifica Log

Controllare i log per confermare assenza di errori:

```powershell
# Log applicazione
Get-Content C:\PSTT_TOOL\logs\app.log -Tail 50

# Log errori
Get-Content C:\PSTT_TOOL\logs\error.log -Tail 20

# Log servizio NSSM
Get-Content C:\PSTT_TOOL\logs\service_stdout.log -Tail 30
```

**Pattern atteso nei log dopo restart da UI**:
```
INFO: Restarting service: PSTT_Tool
INFO: Strategy 1: Trying Windows native Stop-Service/Start-Service
INFO: Service restart command sent (native Windows commands) for PSTT_Tool
INFO: üöÄ Avvio PSTT Tool...
INFO: ‚úÖ SchedulerService avviato con job da configurazione
INFO: üåê Server in ascolto su http://127.0.0.1:8000
```

**Pattern con fallback a NSSM** (ambienti con policy restrittive):
```
INFO: Restarting service: PSTT_Tool
INFO: Strategy 1: Trying Windows native Stop-Service/Start-Service
WARNING: Strategy 1 failed: Access denied
INFO: Strategy 2: Trying NSSM restart command
INFO: Service restart via NSSM sent for PSTT_Tool
```

## 9) Test Suite (Opzionale - solo per ambienti di test)

Se desideri validare l'installazione con la suite test completa:

```powershell
cd C:\PSTT_TOOL
.\.venv\Scripts\activate
pytest tests/ -v
```

Output atteso: **85 test passati**

## 10) Rollback (se necessario)

In caso di problemi critici:

```powershell
# Stop servizio
Stop-Service -Name PSTT_Tool -Force

# Ripristina backup
robocopy "C:\Backup\PSTT_TOOL_2026-01-17" "C:\PSTT_TOOL" /MIR /R:2 /W:2

# Start servizio
Start-Service -Name PSTT_Tool
```

## Note Finali

- ‚úÖ Questa release migliora l'affidabilit√† del restart in ambienti enterprise con policy restrittive
- ‚úÖ Il restart da UI ora ha 3 strategie di fallback automatiche
- ‚úÖ Non √® pi√π richiesto NSSM nel PATH, ma se disponibile viene usato come fallback
- ‚úÖ Logging dettagliato per troubleshooting (quale strategia ha funzionato/fallito)
- ‚úÖ Nessuna modifica a configurazione, dipendenze o database
- ‚úÖ Retrocompatibile: se Strategia 1 funziona, comportamento identico alla versione precedente

### üéØ Casi d'Uso per Strategia Multi-Fallback

**Ambiente Sviluppo/Collaudo**:
- Strategia 1 (nativi Windows) funziona sempre ‚úÖ
- Restart veloce e diretto

**Ambiente Produzione Enterprise**:
- Strategia 1 pu√≤ fallire per Group Policy / Execution Policy
- Strategia 2 (nssm restart) prende il controllo automaticamente ‚úÖ
- Nessun intervento manuale necessario

**Troubleshooting**:
- I log mostrano esattamente quale strategia √® stata usata
- Facilita diagnosi problemi di permessi/policy
- Operatore pu√≤ verificare configurazione NSSM se necessario

Per problemi o domande: contattare il team di sviluppo PSTT Tool.
